# 数据晾晒统计系统 - 需求规格说明书

## 📋 项目概述

### 1.1 项目背景
本系统旨在构建一个高度可配置的数据统计与录入平台，用于多机构、多业务类别的数据晾晒展示。系统需要支持动态配置统计列、多级表头展示、明细数据录入等功能，满足业务快速扩展的需求。

### 1.2 技术栈
- **前端**: Vue2 + Webpack + Element-UI
- **后端**: Java (Spring Boot/SSM)
- **数据库**: Oracle (PL/SQL)

### 1.3 项目目标
1. 实现灵活可配置的数据统计列表展示
2. 支持多级表头的树形结构配置
3. 提供通用的动态表单配置与数据录入能力
4. 记录各业务类别的每日统计底数
5. 具备良好的扩展性，支持新业务快速接入

---

## 🎯 功能需求

### 2.1 数据统计列表展示

#### 2.1.1 基础功能
- **固定列**: 管辖机构、总数
- **动态列**: 根据配置动态生成业务指标列
- **多级表头**: 支持树形结构的多级表头展示
- **数据聚合**: 按机构维度展示各业务指标的统计数据

#### 2.1.2 业务类别示例
业务指标采用树形分类结构，支持多层嵌套：

```
├─ 实有人口
│  ├─ 总数
│  ├─ 流动人口数
│  ├─ 核查率
│  ├─ 抽查总数
│  └─ 抽查不合格数
├─ 实有单位
│  ├─ 总数
│  ├─ 新增单位数
│  └─ 核查率
├─ 特定对象
│  ├─ 重点人员数
│  ├─ 特殊群体数
│  └─ 管控率
└─ 矛盾纠纷
   ├─ 总数
   ├─ 已调解数
   └─ 调解成功率
```

#### 2.1.3 展示规则
- 支持配置默认展开/收起状态
- 多级列表初始化时可配置是否全部展开
- 支持用户手动展开/收起子列

### 2.2 二级明细录入

#### 2.2.1 触发机制
- 点击可配置的统计列单元格
- 弹出对应的明细数据录入窗口

#### 2.2.2 功能要求
- 支持新增、修改、删除明细数据
- 每个业务类别可关联不同的录入表单
- 明细数据变更后自动更新统计数据

#### 2.2.3 示例场景
点击"抽查总数"单元格 → 弹出"抽查记录"表单 → 可录入:
- 抽查时间
- 抽查人员
- 抽查对象
- 抽查结果
- 备注信息

### 2.3 列配置管理

#### 2.3.1 配置功能
- **树形结构配置**: 支持多级列的嵌套配置
- **列属性配置**:
  - 列标题 (label)
  - 数据属性 (prop)
  - 列宽度 (width)
  - 对齐方式 (align)
  - 是否固定 (fixed)
  - 默认展开状态 (defaultExpand)
  - 排序规则 (sortable)
- **关联表单配置**: 配置点击后打开的表单ID
- **计算规则配置**: 配置统计数据的计算方式

#### 2.3.2 操作功能
- 拖拽调整列顺序
- 新增/删除/编辑列配置
- 批量导入/导出配置
- 配置版本管理

#### 2.3.3 配置示例
```json
{
  "id": "001",
  "label": "实有人口",
  "prop": null,
  "children": [
    {
      "id": "001001",
      "label": "总数",
      "prop": "population_total",
      "formId": null,
      "defaultExpand": true
    },
    {
      "id": "001002",
      "label": "抽查总数",
      "prop": "check_total",
      "formId": "form_check_record",
      "defaultExpand": false
    }
  ]
}
```

### 2.4 动态表单配置

#### 2.4.1 表单基础配置
- **表单信息**:
  - 表单名称
  - 表单编码
  - 关联数据表名
  - 表单说明
  - 启用状态

#### 2.4.2 表单项配置
每个表单项可配置:
- **基础属性**:
  - 字段名称 (fieldName)
  - 字段标签 (label)
  - 字段类型 (input/select/date/textarea/number等)
  - 默认值 (defaultValue)
  - 占位符 (placeholder)
- **验证规则**:
  - 是否必填 (required)
  - 最大长度 (maxLength)
  - 正则校验 (pattern)
  - 自定义校验 (validator)
- **数据映射**:
  - 前端字段名 (frontField)
  - 数据库列名 (dbColumn)
  - 数据类型 (dataType)
  - 是否索引字段 (isIndexField)
- **显示控制**:
  - 是否在表单中显示 (showInForm)
  - 是否在列表中显示 (showInList)
  - 是否作为查询条件 (showInQuery)
  - 列宽度 (columnWidth)
  - 列排序 (columnSort)

#### 2.4.3 字段映射机制
**核心思想**: 
- 所有数据完整存储在JSON字段中
- 重要字段映射到数据库列，便于查询和索引

**示例**:
```json
{
  "fieldName": "checkTime",
  "label": "抽查时间",
  "frontField": "checkTime",
  "dbColumn": "CHECK_TIME",
  "isIndexField": true,
  "dataType": "DATE"
}
```

数据存储:
- `DATA_JSON`: `{"checkTime": "2025-11-25", "checker": "张三", ...}`
- `CHECK_TIME`: `2025-11-25` (映射列，便于查询)

#### 2.4.4 表单操作配置
- **新增页配置**: 选择哪些字段在新增时显示
- **编辑页配置**: 选择哪些字段在编辑时显示/只读
- **列表页配置**: 选择哪些字段在列表中展示
- **查询条件配置**: 选择哪些字段作为查询条件

### 2.5 统计底数记录

#### 2.5.1 记录规则
- 每日定时生成统计快照
- 按机构、业务类别维度记录
- 记录时间戳和统计值

#### 2.5.2 记录内容
- 机构ID
- 业务类别
- 统计日期
- 各项指标值
- 数据来源 (实时计算/手动录入)
- 更新时间

#### 2.5.3 用途
- 历史数据对比
- 趋势分析
- 数据审计
- 快速查询历史统计

---

## 🏗️ 非功能需求

### 3.1 性能要求
- 列表首屏加载时间 < 2秒
- 支持1000+机构数据展示
- 分页加载，单页50-100条
- 统计数据缓存，避免频繁计算

### 3.2 扩展性要求
- 新增业务类别无需修改代码，仅需配置
- 新增表单字段无需修改表结构（非索引字段）
- 支持多级表头无限层级嵌套
- 支持权限粒度到列级别

### 3.3 兼容性要求
- 浏览器: Chrome 80+, Edge 80+, Firefox 75+
- 分辨率: 1366x768 及以上
- Oracle 11g 及以上版本

### 3.4 安全性要求
- 数据权限按机构隔离
- 操作日志记录
- 敏感数据脱敏展示
- 防止SQL注入

### 3.5 易用性要求
- 配置界面可视化操作
- 支持拖拽排序
- 实时预览配置效果
- 提供配置模板

---

## 📊 数据流转

### 4.1 统计数据展示流程
```
用户访问列表页
    ↓
加载列配置 (树形结构)
    ↓
生成多级表头
    ↓
查询统计数据 (基于配置的prop)
    ↓
渲染数据到表格
```

### 4.2 明细数据录入流程
```
点击统计单元格
    ↓
获取列配置的formId
    ↓
加载表单配置
    ↓
动态渲染表单
    ↓
提交数据 (JSON + 映射列)
    ↓
更新统计数据
    ↓
刷新列表
```

### 4.3 配置变更流程
```
修改列配置/表单配置
    ↓
保存配置到数据库
    ↓
(可选) 动态添加数据库列
    ↓
清除缓存
    ↓
前端重新加载配置
```

---

## 🎨 界面原型

### 5.1 数据统计列表页
```
┌─────────────────────────────────────────────────────────────┐
│  数据晾晒统计列表                            [配置] [导出]   │
├─────────┬────┬─────────────────────────────────────────────┤
│ 管辖机构 │总数│ 实有人口                    │ 实有单位 │... │
│         │    ├────┬────┬────┬──────┬──────┤          │    │
│         │    │总数│流动│核查│抽查  │不合格│  ...     │    │
├─────────┼────┼────┼────┼────┼──────┼──────┼──────────┼────┤
│ XX街道   │ 500│ 200│ 80 │95% │ [50] │  5   │   100    │... │
│ YY街道   │ 300│ 150│ 60 │92% │ [30] │  3   │   80     │... │
└─────────┴────┴────┴────┴────┴──────┴──────┴──────────┴────┘
说明: [50] 表示可点击录入明细
```

### 5.2 列配置管理页
```
┌─────────────────────────────────────────────────────────────┐
│  列配置管理                              [新增] [导入] [导出]│
├─────────────────────────────────────────────────────────────┤
│  列树形结构                    │  列详细配置                  │
│  ├─ 管辖机构                   │  ┌───────────────────────┐ │
│  ├─ 总数                       │  │ 列标题: 抽查总数       │ │
│  ├─ 实有人口                   │  │ 属性名: check_total │ │
│  │  ├─ 总数                    │  │ 列宽: 100px           │ │
│  │  ├─ 流动人口数              │  │ 对齐: center          │ │
│  │  ├─ 核查率                  │  │ 关联表单: [选择]      │ │
│  │  ├─ 抽查总数 ←             │  │ 默认展开: ☑           │ │
│  │  └─ 抽查不合格数            │  └───────────────────────┘ │
│  └─ 实有单位                   │         [保存] [取消]      │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 动态表单配置页
```
┌─────────────────────────────────────────────────────────────┐
│  表单配置: 抽查记录表单                  [预览] [保存]       │
├─────────────────────────────────────────────────────────────┤
│  表单字段列表                  │  字段配置                    │
│  ┌─────────────────────────┐  │  ┌───────────────────────┐  │
│  │ 1. 抽查时间 [↑] [↓] [×]│  │  │ 字段名: checkTime     │  │
│  │ 2. 抽查人员 [↑] [↓] [×]│  │  │ 标签: 抽查时间        │  │
│  │ 3. 抽查对象 [↑] [↓] [×]│  │  │ 类型: date            │  │
│  │ 4. 抽查结果 [↑] [↓] [×]│  │  │ 必填: ☑               │  │
│  │        [+ 添加字段]      │  │  │ 数据库列: CHECK_TIME  │  │
│  └─────────────────────────┘  │  │ 索引字段: ☑           │  │
│                                │  │ 列表显示: ☑           │  │
│                                │  │ 查询条件: ☑           │  │
│                                │  └───────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 5.4 明细数据录入弹窗
```
┌─────────────────────────────────────────────────────────────┐
│  XX街道 - 抽查记录                               [查询] [新增]│
├─────────────────────────────────────────────────────────────┤
│  抽查时间: [       ]  抽查人员: [    ]       [查询] [重置]  │
├────┬──────────┬──────────┬──────────┬──────────┬──────────┤
│ 序号│ 抽查时间  │ 抽查人员  │ 抽查对象  │ 抽查结果  │ 操作    │
├────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ 1  │2025-11-20│  张三    │  李四    │  合格    │[编辑][删除]│
│ 2  │2025-11-21│  王五    │  赵六    │  不合格  │[编辑][删除]│
└────┴──────────┴──────────┴──────────┴──────────┴──────────┘
                                                   [1] 2 3 >
```

---

## 🔄 业务规则

### 6.1 统计数据计算规则
1. **实时计算**: 统计值从明细数据实时聚合
2. **定时更新**: 每日凌晨生成统计快照
3. **手动刷新**: 支持用户手动触发统计更新
4. **增量更新**: 明细数据变更时仅更新相关统计

### 6.2 权限控制规则
1. **数据权限**: 用户只能查看/编辑所属机构数据
2. **配置权限**: 仅管理员可配置列和表单
3. **操作权限**: 根据角色控制增删改查权限

### 6.3 数据校验规则
1. **必填校验**: 根据表单配置的required属性
2. **格式校验**: 根据字段类型和正则表达式
3. **业务校验**: 自定义校验规则（如日期范围）
4. **唯一性校验**: 可配置字段唯一性约束

### 6.4 配置变更规则
1. **向下兼容**: 配置变更不影响历史数据
2. **热更新**: 配置变更后前端无需重新发版
3. **版本控制**: 记录配置变更历史
4. **灰度发布**: 支持配置按机构灰度生效

---

## 📈 扩展场景

### 7.1 新增业务类别
**场景**: 需要新增"矛盾纠纷"统计类别

**操作流程**:
1. 在列配置中新增"矛盾纠纷"父节点
2. 添加子节点: 总数、已调解数、调解成功率等
3. 配置对应的prop和关联表单
4. 前端自动渲染新列，无需修改代码

### 7.2 新增表单字段
**场景**: "抽查记录"表单需要新增"整改期限"字段

**操作流程**:
1. 在表单配置中添加新字段
2. 配置字段为索引字段 → 系统自动执行ALTER TABLE
3. 配置字段为非索引字段 → 仅存储在JSON中
4. 表单自动渲染新字段

### 7.3 多维度统计
**场景**: 需要按月度、季度、年度统计

**扩展方案**:
1. 在列配置中增加"统计周期"属性
2. 在底数记录表中增加周期字段
3. 查询时根据周期筛选数据

### 7.4 导出报表
**场景**: 需要导出Excel报表

**实现方式**:
1. 根据当前列配置动态生成Excel表头
2. 按配置的prop导出数据
3. 支持多级表头的Excel合并单元格

---

## ✅ 验收标准

### 8.1 功能验收
- [ ] 数据统计列表正确展示多级表头
- [ ] 点击统计数据能弹出对应明细录入窗口
- [ ] 列配置支持树形结构拖拽编辑
- [ ] 动态表单配置能正常渲染表单
- [ ] 明细数据提交后统计数据自动更新
- [ ] 每日统计底数正常记录

### 8.2 性能验收
- [ ] 列表首屏加载 < 2秒
- [ ] 支持500+机构数据流畅展示
- [ ] 表单提交响应 < 1秒

### 8.3 扩展性验收
- [ ] 新增业务类别无需修改代码
- [ ] 新增表单字段仅需配置
- [ ] 支持5级以上多级表头

### 8.4 易用性验收
- [ ] 配置界面操作直观
- [ ] 表单校验提示清晰
- [ ] 支持批量操作

---

## 📝 附录

### 附录A: 术语表
- **数据晾晒**: 公开展示各机构数据统计情况
- **多级表头**: 表格列的树形嵌套结构
- **动态表单**: 根据配置动态渲染的表单
- **字段映射**: 前端字段名与数据库列名的对应关系
- **统计底数**: 用于统计的基础数据快照

### 附录B: 参考资料
- Element-UI Table组件文档
- Vue2组件开发规范
- Oracle PL/SQL开发手册

### 附录C: 变更记录
| 版本 | 日期       | 修订人 | 变更内容 |
| ---- | ---------- | ------ | -------- |
| 1.0  | 2025-11-25 | -      | 初始版本 |
