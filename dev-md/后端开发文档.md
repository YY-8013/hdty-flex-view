# æ•°æ®æ™¾æ™’ç»Ÿè®¡ç³»ç»Ÿ - åç«¯å¼€å‘æ–‡æ¡£

## ğŸ¯ æŠ€æœ¯æ ˆ

### 1.1 æ ¸å¿ƒæ¡†æ¶
- **å¼€å‘æ¡†æ¶**: Spring Boot 2.x / SSM
- **ORMæ¡†æ¶**: MyBatis / MyBatis-Plus
- **æ•°æ®åº“**: Oracle 11g+
- **è¿æ¥æ± **: Druid
- **å·¥å…·åº“**: Hutool, Lombok, FastJSON

### 1.2 å¼€å‘è§„èŒƒ
- RESTful APIè®¾è®¡
- ç»Ÿä¸€è¿”å›æ ¼å¼
- ç»Ÿä¸€å¼‚å¸¸å¤„ç†
- æ—¥å¿—è§„èŒƒ

---

## ğŸ“ é¡¹ç›®ç›®å½•ç»“æ„

```
hdty-data-backend/
â”œâ”€ src/main/java/com/hdty/data/
â”‚  â”œâ”€ config/                       # é…ç½®ç±»
â”‚  â”‚  â”œâ”€ DruidConfig.java           # æ•°æ®æºé…ç½®
â”‚  â”‚  â”œâ”€ MyBatisConfig.java         # MyBatisé…ç½®
â”‚  â”‚  â””â”€ WebMvcConfig.java          # Webé…ç½®
â”‚  â”œâ”€ controller/                   # æ§åˆ¶å™¨
â”‚  â”‚  â”œâ”€ ColumnController.java      # åˆ—é…ç½®æ¥å£
â”‚  â”‚  â”œâ”€ FormController.java        # è¡¨å•é…ç½®æ¥å£
â”‚  â”‚  â”œâ”€ DataController.java        # ä¸šåŠ¡æ•°æ®æ¥å£
â”‚  â”‚  â””â”€ StatController.java        # ç»Ÿè®¡æ¥å£
â”‚  â”œâ”€ service/                      # æœåŠ¡å±‚
â”‚  â”‚  â”œâ”€ IColumnService.java
â”‚  â”‚  â”œâ”€ IFormService.java
â”‚  â”‚  â”œâ”€ IDataService.java
â”‚  â”‚  â”œâ”€ IStatService.java
â”‚  â”‚  â””â”€ impl/                      # æœåŠ¡å®ç°
â”‚  â”‚     â”œâ”€ ColumnServiceImpl.java
â”‚  â”‚     â”œâ”€ FormServiceImpl.java
â”‚  â”‚     â”œâ”€ DataServiceImpl.java
â”‚  â”‚     â””â”€ StatServiceImpl.java
â”‚  â”œâ”€ mapper/                       # Mapperæ¥å£
â”‚  â”‚  â”œâ”€ ColumnMapper.java
â”‚  â”‚  â”œâ”€ FormMapper.java
â”‚  â”‚  â”œâ”€ DataMapper.java
â”‚  â”‚  â””â”€ StatMapper.java
â”‚  â”œâ”€ entity/                       # å®ä½“ç±»
â”‚  â”‚  â”œâ”€ SysColumnConfig.java       # åˆ—é…ç½®å®ä½“
â”‚  â”‚  â”œâ”€ SysFormConfig.java         # è¡¨å•é…ç½®å®ä½“
â”‚  â”‚  â”œâ”€ SysFormFieldConfig.java    # å­—æ®µé…ç½®å®ä½“
â”‚  â”‚  â”œâ”€ BizDataCommon.java         # ä¸šåŠ¡æ•°æ®å®ä½“
â”‚  â”‚  â””â”€ StatDailyBase.java         # ç»Ÿè®¡åº•æ•°å®ä½“
â”‚  â”œâ”€ dto/                          # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚  â”‚  â”œâ”€ ColumnDTO.java
â”‚  â”‚  â”œâ”€ FormDTO.java
â”‚  â”‚  â”œâ”€ DataQueryDTO.java
â”‚  â”‚  â””â”€ StatQueryDTO.java
â”‚  â”œâ”€ vo/                           # è§†å›¾å¯¹è±¡
â”‚  â”‚  â”œâ”€ ColumnTreeVO.java          # åˆ—æ ‘å½¢VO
â”‚  â”‚  â”œâ”€ FormDetailVO.java          # è¡¨å•è¯¦æƒ…VO
â”‚  â”‚  â”œâ”€ DataListVO.java            # æ•°æ®åˆ—è¡¨VO
â”‚  â”‚  â””â”€ StatDataVO.java            # ç»Ÿè®¡æ•°æ®VO
â”‚  â”œâ”€ common/                       # å…¬å…±ç±»
â”‚  â”‚  â”œâ”€ Result.java                # ç»Ÿä¸€è¿”å›ç±»
â”‚  â”‚  â”œâ”€ PageResult.java            # åˆ†é¡µè¿”å›ç±»
â”‚  â”‚  â”œâ”€ Constant.java              # å¸¸é‡ç±»
â”‚  â”‚  â””â”€ exception/                 # å¼‚å¸¸ç±»
â”‚  â”‚     â”œâ”€ BusinessException.java
â”‚  â”‚     â””â”€ GlobalExceptionHandler.java
â”‚  â”œâ”€ util/                         # å·¥å…·ç±»
â”‚  â”‚  â”œâ”€ TreeUtil.java              # æ ‘å½¢æ•°æ®å·¥å…·
â”‚  â”‚  â”œâ”€ JsonUtil.java              # JSONå·¥å…·
â”‚  â”‚  â”œâ”€ SqlUtil.java               # SQLåŠ¨æ€æ„å»ºå·¥å…·
â”‚  â”‚  â””â”€ FieldMapUtil.java          # å­—æ®µæ˜ å°„å·¥å…·
â”‚  â””â”€ DataApplication.java          # å¯åŠ¨ç±»
â”œâ”€ src/main/resources/
â”‚  â”œâ”€ mapper/                       # MyBatisæ˜ å°„æ–‡ä»¶
â”‚  â”‚  â”œâ”€ ColumnMapper.xml
â”‚  â”‚  â”œâ”€ FormMapper.xml
â”‚  â”‚  â”œâ”€ DataMapper.xml
â”‚  â”‚  â””â”€ StatMapper.xml
â”‚  â”œâ”€ application.yml               # é…ç½®æ–‡ä»¶
â”‚  â””â”€ logback-spring.xml            # æ—¥å¿—é…ç½®
â””â”€ pom.xml                          # Mavené…ç½®
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 2.1 ç»Ÿä¸€è¿”å›æ ¼å¼

```java
// common/Result.java
package com.hdty.data.common;

import lombok.Data;

@Data
public class Result<T> {
    private Integer code;
    private String message;
    private T data;
    
    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage("success");
        result.setData(data);
        return result;
    }
    
    public static <T> Result<T> success() {
        return success(null);
    }
    
    public static <T> Result<T> error(String message) {
        Result<T> result = new Result<>();
        result.setCode(500);
        result.setMessage(message);
        return result;
    }
    
    public static <T> Result<T> error(Integer code, String message) {
        Result<T> result = new Result<>();
        result.setCode(code);
        result.setMessage(message);
        return result;
    }
}
```

```java
// common/PageResult.java
package com.hdty.data.common;

import lombok.Data;
import java.util.List;

@Data
public class PageResult<T> {
    private Long total;
    private List<T> rows;
    private Integer pageNum;
    private Integer pageSize;
    
    public PageResult(Long total, List<T> rows, Integer pageNum, Integer pageSize) {
        this.total = total;
        this.rows = rows;
        this.pageNum = pageNum;
        this.pageSize = pageSize;
    }
}
```

---

### 2.2 åˆ—é…ç½®ç®¡ç†

#### 2.2.1 å®ä½“ç±»

```java
// entity/SysColumnConfig.java
package com.hdty.data.entity;

import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.util.Date;

@Data
@TableName("SYS_COLUMN_CONFIG")
public class SysColumnConfig {
    @TableId
    private String id;
    private String parentId;
    private String label;
    private String prop;
    private Integer columnWidth;
    private String align;
    private String fixed;
    private String sortable;
    private String defaultExpand;
    private String formId;
    private String calcType;
    private String calcRule;
    private Integer sortNum;
    private String status;
    private String remark;
    private String createBy;
    private Date createTime;
    private String updateBy;
    private Date updateTime;
}
```

#### 2.2.2 VOå¯¹è±¡

```java
// vo/ColumnTreeVO.java
package com.hdty.data.vo;

import lombok.Data;
import java.util.List;

@Data
public class ColumnTreeVO {
    private String id;
    private String parentId;
    private String label;
    private String prop;
    private Integer width;
    private String align;
    private String fixed;
    private String defaultExpand;
    private String formId;
    private Integer sortNum;
    private List<ColumnTreeVO> children;
}
```

#### 2.2.3 Serviceå®ç°

```java
// service/impl/ColumnServiceImpl.java
package com.hdty.data.service.impl;

import com.hdty.data.entity.SysColumnConfig;
import com.hdty.data.mapper.ColumnMapper;
import com.hdty.data.service.IColumnService;
import com.hdty.data.vo.ColumnTreeVO;
import com.hdty.data.util.TreeUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.stereotype.Service;
import javax.annotation.Resource;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class ColumnServiceImpl implements IColumnService {
    
    @Resource
    private ColumnMapper columnMapper;
    
    @Override
    public List<ColumnTreeVO> getColumnTree() {
        // æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„åˆ—é…ç½®
        List<SysColumnConfig> list = columnMapper.selectList(
            new QueryWrapper<SysColumnConfig>()
                .eq("STATUS", "1")
                .orderByAsc("SORT_NUM")
        );
        
        // è½¬æ¢ä¸ºVO
        List<ColumnTreeVO> voList = list.stream().map(config -> {
            ColumnTreeVO vo = new ColumnTreeVO();
            BeanUtils.copyProperties(config, vo);
            vo.setWidth(config.getColumnWidth());
            return vo;
        }).collect(Collectors.toList());
        
        // æ„å»ºæ ‘å½¢ç»“æ„
        return TreeUtil.buildTree(voList, "id", "parentId", "children");
    }
    
    @Override
    public void saveColumn(SysColumnConfig config) {
        if (config.getId() == null) {
            // æ–°å¢
            config.setId(UUID.randomUUID().toString().replace("-", ""));
            config.setCreateTime(new Date());
            columnMapper.insert(config);
        } else {
            // æ›´æ–°
            config.setUpdateTime(new Date());
            columnMapper.updateById(config);
        }
    }
    
    @Override
    public void deleteColumn(String id) {
        // é€»è¾‘åˆ é™¤
        SysColumnConfig config = new SysColumnConfig();
        config.setId(id);
        config.setStatus("0");
        config.setUpdateTime(new Date());
        columnMapper.updateById(config);
    }
}
```

#### 2.2.4 Controller

```java
// controller/ColumnController.java
package com.hdty.data.controller;

import com.hdty.data.common.Result;
import com.hdty.data.entity.SysColumnConfig;
import com.hdty.data.service.IColumnService;
import com.hdty.data.vo.ColumnTreeVO;
import org.springframework.web.bind.annotation.*;
import javax.annotation.Resource;
import java.util.List;

@RestController
@RequestMapping("/api/column")
public class ColumnController {
    
    @Resource
    private IColumnService columnService;
    
    /**
     * è·å–åˆ—é…ç½®æ ‘
     */
    @GetMapping("/tree")
    public Result<List<ColumnTreeVO>> getColumnTree() {
        List<ColumnTreeVO> tree = columnService.getColumnTree();
        return Result.success(tree);
    }
    
    /**
     * è·å–åˆ—é…ç½®è¯¦æƒ…
     */
    @GetMapping("/{id}")
    public Result<SysColumnConfig> getColumnDetail(@PathVariable String id) {
        SysColumnConfig config = columnService.getById(id);
        return Result.success(config);
    }
    
    /**
     * ä¿å­˜åˆ—é…ç½®
     */
    @PostMapping("/save")
    public Result<Void> saveColumn(@RequestBody SysColumnConfig config) {
        columnService.saveColumn(config);
        return Result.success();
    }
    
    /**
     * åˆ é™¤åˆ—é…ç½®
     */
    @DeleteMapping("/{id}")
    public Result<Void> deleteColumn(@PathVariable String id) {
        columnService.deleteColumn(id);
        return Result.success();
    }
}
```

---

### 2.3 åŠ¨æ€è¡¨å•ç®¡ç†

#### 2.3.1 å®ä½“ç±»

```java
// entity/SysFormConfig.java
package com.hdty.data.entity;

import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.util.Date;

@Data
@TableName("SYS_FORM_CONFIG")
public class SysFormConfig {
    @TableId
    private String id;
    private String formCode;
    private String formName;
    private String dataTable;
    private String formType;
    private String description;
    private String status;
    private Integer version;
    private String remark;
    private String createBy;
    private Date createTime;
    private String updateBy;
    private Date updateTime;
}
```

```java
// entity/SysFormFieldConfig.java
package com.hdty.data.entity;

import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.util.Date;

@Data
@TableName("SYS_FORM_FIELD_CONFIG")
public class SysFormFieldConfig {
    @TableId
    private String id;
    private String formId;
    private String fieldName;
    private String fieldLabel;
    private String fieldType;
    private String defaultValue;
    private String placeholder;
    
    // éªŒè¯è§„åˆ™
    private String isRequired;
    private Integer maxLength;
    private Integer minLength;
    private String pattern;
    private String validator;
    
    // æ•°æ®æ˜ å°„
    private String dbColumn;
    private String dataType;
    private String isIndexField;
    
    // æ˜¾ç¤ºæ§åˆ¶
    private String showInForm;
    private String showInList;
    private String showInQuery;
    private Integer columnWidth;
    private Integer columnSort;
    private Integer formSort;
    
    // é€‰æ‹©æ¡†é…ç½®
    private String dictType;
    private String optionsData;
    
    // å…¶ä»–é…ç½®
    private String extraConfig;
    private String status;
    private String remark;
    private String createBy;
    private Date createTime;
    private String updateBy;
    private Date updateTime;
}
```

#### 2.3.2 Serviceå®ç°

```java
// service/impl/FormServiceImpl.java
package com.hdty.data.service.impl;

import com.hdty.data.entity.SysFormConfig;
import com.hdty.data.entity.SysFormFieldConfig;
import com.hdty.data.mapper.FormMapper;
import com.hdty.data.mapper.FormFieldMapper;
import com.hdty.data.service.IFormService;
import com.hdty.data.util.SqlUtil;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import javax.annotation.Resource;
import java.util.List;

@Service
public class FormServiceImpl implements IFormService {
    
    @Resource
    private FormMapper formMapper;
    
    @Resource
    private FormFieldMapper formFieldMapper;
    
    @Resource
    private SqlUtil sqlUtil;
    
    @Override
    public List<SysFormConfig> getFormList() {
        return formMapper.selectList(
            new QueryWrapper<SysFormConfig>().eq("STATUS", "1")
        );
    }
    
    @Override
    public SysFormConfig getFormById(String id) {
        return formMapper.selectById(id);
    }
    
    @Override
    public List<SysFormFieldConfig> getFormFields(String formId) {
        return formFieldMapper.selectList(
            new QueryWrapper<SysFormFieldConfig>()
                .eq("FORM_ID", formId)
                .eq("STATUS", "1")
                .orderByAsc("FORM_SORT")
        );
    }
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void saveFormField(SysFormFieldConfig field) {
        if (field.getId() == null) {
            // æ–°å¢å­—æ®µ
            field.setId(UUID.randomUUID().toString().replace("-", ""));
            field.setCreateTime(new Date());
            formFieldMapper.insert(field);
            
            // å¦‚æœæ˜¯ç´¢å¼•å­—æ®µ,åŠ¨æ€æ·»åŠ æ•°æ®åº“åˆ—
            if ("true".equals(field.getIsIndexField())) {
                addDataColumn(field);
            }
        } else {
            // æ›´æ–°å­—æ®µ
            field.setUpdateTime(new Date());
            formFieldMapper.updateById(field);
        }
    }
    
    /**
     * åŠ¨æ€æ·»åŠ æ•°æ®åˆ—
     */
    private void addDataColumn(SysFormFieldConfig field) {
        String columnName = field.getDbColumn();
        String dataType = field.getDataType();
        Integer maxLength = field.getMaxLength() != null ? field.getMaxLength() : 100;
        
        // æ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨
        if (!sqlUtil.columnExists("BIZ_DATA_COMMON", columnName)) {
            // æ·»åŠ åˆ—
            sqlUtil.addColumn("BIZ_DATA_COMMON", columnName, dataType, maxLength);
            // åˆ›å»ºç´¢å¼•
            sqlUtil.createIndex("BIZ_DATA_COMMON", columnName);
        }
    }
}
```

---

### 2.4 ä¸šåŠ¡æ•°æ®ç®¡ç† (æ ¸å¿ƒ)

#### 2.4.1 å®ä½“ç±»

```java
// entity/BizDataCommon.java
package com.hdty.data.entity;

import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.util.Date;
import java.util.Map;

@Data
@TableName("BIZ_DATA_COMMON")
public class BizDataCommon {
    @TableId
    private String id;
    private String formId;
    private String orgId;
    private String dataJson;  // CLOBå­—æ®µ
    
    // åŠ¨æ€æ˜ å°„å­—æ®µä¼šé€šè¿‡åå°„è®¾ç½®
    // ä¾‹å¦‚: checkTime, checker, checkResultç­‰
    
    private String status;
    private String createBy;
    private Date createTime;
    private String updateBy;
    private Date updateTime;
    
    // ç”¨äºå­˜å‚¨åŠ¨æ€å­—æ®µ
    private Map<String, Object> dynamicFields;
}
```

#### 2.4.2 DTOå¯¹è±¡

```java
// dto/DataQueryDTO.java
package com.hdty.data.dto;

import lombok.Data;
import java.util.Map;

@Data
public class DataQueryDTO {
    private String formId;
    private String orgId;
    private Map<String, Object> queryParams;  // åŠ¨æ€æŸ¥è¯¢æ¡ä»¶
    private Integer pageNum;
    private Integer pageSize;
}
```

#### 2.4.3 Serviceå®ç° (åŠ¨æ€SQLæ ¸å¿ƒ)

```java
// service/impl/DataServiceImpl.java
package com.hdty.data.service.impl;

import com.alibaba.fastjson.JSON;
import com.hdty.data.entity.BizDataCommon;
import com.hdty.data.entity.SysFormFieldConfig;
import com.hdty.data.mapper.DataMapper;
import com.hdty.data.service.IDataService;
import com.hdty.data.service.IFormService;
import com.hdty.data.dto.DataQueryDTO;
import com.hdty.data.util.FieldMapUtil;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import javax.annotation.Resource;
import java.util.*;

@Service
public class DataServiceImpl implements IDataService {
    
    @Resource
    private DataMapper dataMapper;
    
    @Resource
    private IFormService formService;
    
    @Override
    public List<Map<String, Object>> queryDataList(DataQueryDTO queryDTO) {
        // è·å–è¡¨å•å­—æ®µé…ç½®
        List<SysFormFieldConfig> fields = formService.getFormFields(queryDTO.getFormId());
        
        // æ„å»ºåŠ¨æ€æŸ¥è¯¢æ¡ä»¶
        Map<String, Object> params = new HashMap<>();
        params.put("formId", queryDTO.getFormId());
        params.put("orgId", queryDTO.getOrgId());
        
        // ç´¢å¼•å­—æ®µæŸ¥è¯¢æ¡ä»¶
        List<SysFormFieldConfig> indexFields = fields.stream()
            .filter(f -> "true".equals(f.getIsIndexField()))
            .collect(Collectors.toList());
        
        Map<String, Object> indexConditions = new HashMap<>();
        if (queryDTO.getQueryParams() != null) {
            for (SysFormFieldConfig field : indexFields) {
                String fieldName = field.getFieldName();
                if (queryDTO.getQueryParams().containsKey(fieldName)) {
                    indexConditions.put(field.getDbColumn(), 
                        queryDTO.getQueryParams().get(fieldName));
                }
            }
        }
        params.put("indexConditions", indexConditions);
        
        // æ‰§è¡ŒæŸ¥è¯¢
        List<BizDataCommon> dataList = dataMapper.selectByDynamicCondition(params);
        
        // ç»„è£…è¿”å›æ•°æ®(åˆå¹¶JSONå’Œæ˜ å°„å­—æ®µ)
        return dataList.stream().map(data -> {
            Map<String, Object> result = new HashMap<>();
            result.put("id", data.getId());
            result.put("orgId", data.getOrgId());
            
            // è§£æJSONæ•°æ®
            Map<String, Object> jsonData = JSON.parseObject(data.getDataJson(), Map.class);
            result.putAll(jsonData);
            
            // æ·»åŠ æ˜ å°„å­—æ®µ(ä¼˜å…ˆçº§é«˜äºJSON)
            for (SysFormFieldConfig field : indexFields) {
                try {
                    Object value = FieldMapUtil.getFieldValue(data, field.getDbColumn());
                    if (value != null) {
                        result.put(field.getFieldName(), value);
                    }
                } catch (Exception e) {
                    // å¿½ç•¥
                }
            }
            
            return result;
        }).collect(Collectors.toList());
    }
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void saveData(Map<String, Object> dataMap) {
        String formId = (String) dataMap.get("formId");
        String orgId = (String) dataMap.get("orgId");
        String id = (String) dataMap.get("id");
        
        // è·å–è¡¨å•å­—æ®µé…ç½®
        List<SysFormFieldConfig> fields = formService.getFormFields(formId);
        
        BizDataCommon entity = new BizDataCommon();
        entity.setFormId(formId);
        entity.setOrgId(orgId);
        
        // åˆ†ç¦»ç´¢å¼•å­—æ®µå’Œæ™®é€šå­—æ®µ
        Map<String, Object> jsonData = new HashMap<>();
        Map<String, Object> indexData = new HashMap<>();
        
        for (Map.Entry<String, Object> entry : dataMap.entrySet()) {
            String key = entry.getKey();
            if ("formId".equals(key) || "orgId".equals(key) || "id".equals(key)) {
                continue;
            }
            
            // æŸ¥æ‰¾å¯¹åº”çš„å­—æ®µé…ç½®
            Optional<SysFormFieldConfig> fieldOpt = fields.stream()
                .filter(f -> f.getFieldName().equals(key))
                .findFirst();
            
            if (fieldOpt.isPresent()) {
                SysFormFieldConfig field = fieldOpt.get();
                if ("true".equals(field.getIsIndexField())) {
                    indexData.put(field.getDbColumn(), entry.getValue());
                }
            }
            
            jsonData.put(key, entry.getValue());
        }
        
        // è®¾ç½®JSONæ•°æ®
        entity.setDataJson(JSON.toJSONString(jsonData));
        
        // è®¾ç½®ç´¢å¼•å­—æ®µ(é€šè¿‡åå°„)
        for (Map.Entry<String, Object> entry : indexData.entrySet()) {
            try {
                FieldMapUtil.setFieldValue(entity, entry.getKey(), entry.getValue());
            } catch (Exception e) {
                throw new RuntimeException("è®¾ç½®å­—æ®µå¤±è´¥: " + entry.getKey(), e);
            }
        }
        
        if (id == null) {
            // æ–°å¢
            entity.setId(UUID.randomUUID().toString().replace("-", ""));
            entity.setStatus("1");
            entity.setCreateTime(new Date());
            dataMapper.insert(entity);
        } else {
            // æ›´æ–°
            entity.setId(id);
            entity.setUpdateTime(new Date());
            dataMapper.updateById(entity);
        }
    }
    
    @Override
    public void deleteData(String id) {
        BizDataCommon entity = new BizDataCommon();
        entity.setId(id);
        entity.setStatus("0");
        entity.setUpdateTime(new Date());
        dataMapper.updateById(entity);
    }
}
```

#### 2.4.4 Mapper XML (åŠ¨æ€SQL)

```xml
<!-- mapper/DataMapper.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdty.data.mapper.DataMapper">
    
    <!-- åŠ¨æ€æŸ¥è¯¢ -->
    <select id="selectByDynamicCondition" parameterType="map" resultType="com.hdty.data.entity.BizDataCommon">
        SELECT * FROM BIZ_DATA_COMMON
        WHERE FORM_ID = #{formId}
        AND STATUS = '1'
        <if test="orgId != null and orgId != ''">
            AND ORG_ID = #{orgId}
        </if>
        <!-- åŠ¨æ€ç´¢å¼•å­—æ®µæŸ¥è¯¢æ¡ä»¶ -->
        <if test="indexConditions != null">
            <foreach collection="indexConditions" index="key" item="value">
                <if test="value != null">
                    AND ${key} = #{value}
                </if>
            </foreach>
        </if>
        ORDER BY CREATE_TIME DESC
    </select>
    
</mapper>
```

---

### 2.5 ç»Ÿè®¡æ•°æ®è®¡ç®—

#### 2.5.1 Serviceå®ç°

```java
// service/impl/StatServiceImpl.java
package com.hdty.data.service.impl;

import com.hdty.data.entity.StatDailyBase;
import com.hdty.data.mapper.StatMapper;
import com.hdty.data.service.IStatService;
import com.hdty.data.vo.StatDataVO;
import org.springframework.stereotype.Service;
import javax.annotation.Resource;
import java.util.*;

@Service
public class StatServiceImpl implements IStatService {
    
    @Resource
    private StatMapper statMapper;
    
    @Override
    public List<StatDataVO> getStatData(String orgId, Date statDate) {
        // å¦‚æœæœªæŒ‡å®šæ—¥æœŸ,ä½¿ç”¨æœ€æ–°æ—¥æœŸ
        if (statDate == null) {
            statDate = new Date();
        }
        
        // æŸ¥è¯¢ç»Ÿè®¡åº•æ•°
        Map<String, Object> params = new HashMap<>();
        params.put("statDate", statDate);
        if (orgId != null) {
            params.put("orgId", orgId);
        }
        
        List<StatDailyBase> statList = statMapper.selectByDate(params);
        
        // è½¬æ¢ä¸ºVO
        return convertToVO(statList);
    }
    
    @Override
    public void refreshStat(String orgId, Date statDate) {
        // è°ƒç”¨å­˜å‚¨è¿‡ç¨‹è®¡ç®—ç»Ÿè®¡æ•°æ®
        Map<String, Object> params = new HashMap<>();
        params.put("statDate", statDate);
        params.put("orgId", orgId);
        
        statMapper.callCalcDailyStat(params);
    }
    
    /**
     * è½¬æ¢ä¸ºå‰ç«¯VO
     */
    private List<StatDataVO> convertToVO(List<StatDailyBase> statList) {
        // æŒ‰æœºæ„åˆ†ç»„
        Map<String, StatDataVO> voMap = new LinkedHashMap<>();
        
        for (StatDailyBase stat : statList) {
            String orgId = stat.getOrgId();
            StatDataVO vo = voMap.computeIfAbsent(orgId, k -> {
                StatDataVO v = new StatDataVO();
                v.setOrgId(orgId);
                // è¿™é‡Œéœ€è¦æŸ¥è¯¢æœºæ„åç§°
                return v;
            });
            
            // æ ¹æ®ä¸šåŠ¡ç±»åˆ«è®¾ç½®å¯¹åº”å­—æ®µ
            switch (stat.getCategory()) {
                case "POPULATION":
                    vo.setPopulationTotal(stat.getPopulationTotal());
                    vo.setPopulationFloating(stat.getPopulationFloating());
                    vo.setPopulationCheckRate(stat.getPopulationCheckRate());
                    vo.setPopulationInspectTotal(stat.getPopulationInspectTotal());
                    vo.setPopulationInspectFail(stat.getPopulationInspectFail());
                    break;
                case "UNIT":
                    vo.setUnitTotal(stat.getUnitTotal());
                    vo.setUnitNew(stat.getUnitNew());
                    vo.setUnitCheckRate(stat.getUnitCheckRate());
                    break;
                // å…¶ä»–ç±»åˆ«...
            }
        }
        
        return new ArrayList<>(voMap.values());
    }
}
```

#### 2.5.2 Mapper XML

```xml
<!-- mapper/StatMapper.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdty.data.mapper.StatMapper">
    
    <!-- æŒ‰æ—¥æœŸæŸ¥è¯¢ç»Ÿè®¡æ•°æ® -->
    <select id="selectByDate" parameterType="map" resultType="com.hdty.data.entity.StatDailyBase">
        SELECT * FROM STAT_DAILY_BASE
        WHERE STAT_DATE = #{statDate}
        <if test="orgId != null">
            AND ORG_ID = #{orgId}
        </if>
        ORDER BY ORG_ID, CATEGORY
    </select>
    
    <!-- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹è®¡ç®—ç»Ÿè®¡æ•°æ® -->
    <select id="callCalcDailyStat" parameterType="map" statementType="CALLABLE">
        {CALL SP_CALC_DAILY_STAT(
            #{statDate, mode=IN, jdbcType=DATE},
            #{orgId, mode=IN, jdbcType=VARCHAR},
            #{result, mode=OUT, jdbcType=VARCHAR}
        )}
    </select>
    
</mapper>
```

---

## ğŸ”§ å·¥å…·ç±»å®ç°

### 3.1 æ ‘å½¢æ•°æ®å·¥å…·

```java
// util/TreeUtil.java
package com.hdty.data.util;

import java.util.ArrayList;
import java.util.List;

public class TreeUtil {
    
    /**
     * æ„å»ºæ ‘å½¢ç»“æ„
     * @param list æ•°æ®åˆ—è¡¨
     * @param idField IDå­—æ®µå
     * @param parentIdField çˆ¶IDå­—æ®µå
     * @param childrenField å­èŠ‚ç‚¹å­—æ®µå
     */
    public static <T> List<T> buildTree(List<T> list, String idField, 
                                         String parentIdField, String childrenField) {
        List<T> roots = new ArrayList<>();
        
        for (T item : list) {
            Object parentId = getFieldValue(item, parentIdField);
            if (parentId == null) {
                // æ ¹èŠ‚ç‚¹
                roots.add(item);
                buildChildren(item, list, idField, parentIdField, childrenField);
            }
        }
        
        return roots;
    }
    
    private static <T> void buildChildren(T parent, List<T> list, 
                                          String idField, String parentIdField, 
                                          String childrenField) {
        Object parentIdValue = getFieldValue(parent, idField);
        List<T> children = new ArrayList<>();
        
        for (T item : list) {
            Object itemParentId = getFieldValue(item, parentIdField);
            if (parentIdValue != null && parentIdValue.equals(itemParentId)) {
                children.add(item);
                buildChildren(item, list, idField, parentIdField, childrenField);
            }
        }
        
        if (!children.isEmpty()) {
            setFieldValue(parent, childrenField, children);
        }
    }
    
    private static Object getFieldValue(Object obj, String fieldName) {
        try {
            Field field = obj.getClass().getDeclaredField(fieldName);
            field.setAccessible(true);
            return field.get(obj);
        } catch (Exception e) {
            return null;
        }
    }
    
    private static void setFieldValue(Object obj, String fieldName, Object value) {
        try {
            Field field = obj.getClass().getDeclaredField(fieldName);
            field.setAccessible(true);
            field.set(obj, value);
        } catch (Exception e) {
            // ignore
        }
    }
}
```

---

### 3.2 å­—æ®µæ˜ å°„å·¥å…·

```java
// util/FieldMapUtil.java
package com.hdty.data.util;

import java.lang.reflect.Field;
import java.text.SimpleDateFormat;
import java.util.Date;

public class FieldMapUtil {
    
    /**
     * è·å–å¯¹è±¡å­—æ®µå€¼
     */
    public static Object getFieldValue(Object obj, String fieldName) 
            throws Exception {
        // è½¬æ¢ä¸ºé©¼å³°å‘½å
        String camelFieldName = toCamelCase(fieldName);
        
        Field field = findField(obj.getClass(), camelFieldName);
        if (field == null) {
            return null;
        }
        
        field.setAccessible(true);
        return field.get(obj);
    }
    
    /**
     * è®¾ç½®å¯¹è±¡å­—æ®µå€¼
     */
    public static void setFieldValue(Object obj, String fieldName, Object value) 
            throws Exception {
        // è½¬æ¢ä¸ºé©¼å³°å‘½å
        String camelFieldName = toCamelCase(fieldName);
        
        Field field = findField(obj.getClass(), camelFieldName);
        if (field == null) {
            throw new NoSuchFieldException("å­—æ®µä¸å­˜åœ¨: " + fieldName);
        }
        
        field.setAccessible(true);
        
        // ç±»å‹è½¬æ¢
        Object convertedValue = convertValue(value, field.getType());
        field.set(obj, convertedValue);
    }
    
    /**
     * æŸ¥æ‰¾å­—æ®µ(åŒ…æ‹¬çˆ¶ç±»)
     */
    private static Field findField(Class<?> clazz, String fieldName) {
        try {
            return clazz.getDeclaredField(fieldName);
        } catch (NoSuchFieldException e) {
            if (clazz.getSuperclass() != null) {
                return findField(clazz.getSuperclass(), fieldName);
            }
            return null;
        }
    }
    
    /**
     * ä¸‹åˆ’çº¿è½¬é©¼å³°
     */
    private static String toCamelCase(String str) {
        if (str == null || str.isEmpty()) {
            return str;
        }
        
        StringBuilder result = new StringBuilder();
        boolean capitalizeNext = false;
        
        for (char c : str.toLowerCase().toCharArray()) {
            if (c == '_') {
                capitalizeNext = true;
            } else {
                if (capitalizeNext) {
                    result.append(Character.toUpperCase(c));
                    capitalizeNext = false;
                } else {
                    result.append(c);
                }
            }
        }
        
        return result.toString();
    }
    
    /**
     * ç±»å‹è½¬æ¢
     */
    private static Object convertValue(Object value, Class<?> targetType) {
        if (value == null) {
            return null;
        }
        
        if (targetType.isAssignableFrom(value.getClass())) {
            return value;
        }
        
        // String -> Date
        if (targetType == Date.class && value instanceof String) {
            try {
                SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
                return sdf.parse((String) value);
            } catch (Exception e) {
                throw new RuntimeException("æ—¥æœŸè½¬æ¢å¤±è´¥", e);
            }
        }
        
        // String -> Number
        if (Number.class.isAssignableFrom(targetType) && value instanceof String) {
            if (targetType == Integer.class) {
                return Integer.parseInt((String) value);
            } else if (targetType == Long.class) {
                return Long.parseLong((String) value);
            } else if (targetType == Double.class) {
                return Double.parseDouble((String) value);
            }
        }
        
        return value;
    }
}
```

---

### 3.3 SQLå·¥å…·

```java
// util/SqlUtil.java
package com.hdty.data.util;

import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;
import javax.annotation.Resource;

@Component
public class SqlUtil {
    
    @Resource
    private JdbcTemplate jdbcTemplate;
    
    /**
     * æ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨
     */
    public boolean columnExists(String tableName, String columnName) {
        String sql = "SELECT COUNT(*) FROM USER_TAB_COLUMNS " +
                     "WHERE TABLE_NAME = ? AND COLUMN_NAME = ?";
        Integer count = jdbcTemplate.queryForObject(sql, Integer.class, 
            tableName.toUpperCase(), columnName.toUpperCase());
        return count != null && count > 0;
    }
    
    /**
     * åŠ¨æ€æ·»åŠ åˆ—
     */
    public void addColumn(String tableName, String columnName, 
                         String dataType, Integer length) {
        String typeStr;
        switch (dataType.toUpperCase()) {
            case "VARCHAR2":
                typeStr = "VARCHAR2(" + length + ")";
                break;
            case "NUMBER":
                typeStr = "NUMBER(20,2)";
                break;
            case "DATE":
                typeStr = "DATE";
                break;
            case "CLOB":
                typeStr = "CLOB";
                break;
            default:
                typeStr = "VARCHAR2(100)";
        }
        
        String sql = "ALTER TABLE " + tableName + " ADD " + 
                     columnName + " " + typeStr;
        jdbcTemplate.execute(sql);
    }
    
    /**
     * åˆ›å»ºç´¢å¼•
     */
    public void createIndex(String tableName, String columnName) {
        String indexName = "IDX_DATA_" + columnName;
        String sql = "CREATE INDEX " + indexName + " ON " + 
                     tableName + "(" + columnName + ")";
        try {
            jdbcTemplate.execute(sql);
        } catch (Exception e) {
            // ç´¢å¼•å¯èƒ½å·²å­˜åœ¨,å¿½ç•¥
        }
    }
}
```

---

## ğŸ“ é…ç½®æ–‡ä»¶

### 4.1 application.yml

```yaml
spring:
  application:
    name: hdty-data-overview
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: oracle.jdbc.OracleDriver
    url: jdbc:oracle:thin:@localhost:1521:orcl
    username: hdty_user
    password: your_password
    druid:
      initial-size: 5
      min-idle: 5
      max-active: 20
      max-wait: 60000
      test-while-idle: true
      validation-query: SELECT 1 FROM DUAL

mybatis-plus:
  mapper-locations: classpath*:mapper/**/*.xml
  type-aliases-package: com.hdty.data.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

server:
  port: 8080
  servlet:
    context-path: /

logging:
  level:
    com.hdty.data: debug
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

---

## ğŸ” å¼‚å¸¸å¤„ç†

```java
// common/exception/GlobalExceptionHandler.java
package com.hdty.data.common.exception;

import com.hdty.data.common.Result;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result<Void> handleBusinessException(BusinessException e) {
        return Result.error(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        e.printStackTrace();
        return Result.error("ç³»ç»Ÿå¼‚å¸¸: " + e.getMessage());
    }
}
```

---

## ğŸ“Š å®šæ—¶ä»»åŠ¡

```java
// task/StatTask.java
package com.hdty.data.task;

import com.hdty.data.service.IStatService;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import javax.annotation.Resource;
import java.util.Date;

@Component
public class StatTask {
    
    @Resource
    private IStatService statService;
    
    /**
     * æ¯æ—¥å‡Œæ™¨1ç‚¹ç”Ÿæˆç»Ÿè®¡æ•°æ®
     */
    @Scheduled(cron = "0 0 1 * * ?")
    public void calcDailyStat() {
        Date yesterday = new Date(System.currentTimeMillis() - 24 * 60 * 60 * 1000);
        statService.refreshStat(null, yesterday);
    }
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-11-25
