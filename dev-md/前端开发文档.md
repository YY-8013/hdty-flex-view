# æ•°æ®æ™¾æ™’ç»Ÿè®¡ç³»ç»Ÿ - å‰ç«¯å¼€å‘æ–‡æ¡£

## ğŸ¯ æŠ€æœ¯æ ˆ

### 1.1 æ ¸å¿ƒæŠ€æœ¯
- **æ¡†æ¶**: Vue 2.6+
- **æ„å»ºå·¥å…·**: Webpack 4/5
- **UIç»„ä»¶åº“**: Element-UI 2.15+
- **çŠ¶æ€ç®¡ç†**: Vuex
- **è·¯ç”±**: Vue Router
- **HTTPå®¢æˆ·ç«¯**: Axios
- **å·¥å…·åº“**: Lodash, Day.js

### 1.2 å¼€å‘è§„èŒƒ
- ES6+ è¯­æ³•
- ç»„ä»¶åŒ–å¼€å‘
- æ¨¡å—åŒ–ç®¡ç†
- å“åº”å¼å¸ƒå±€

---

## ğŸ“ é¡¹ç›®ç›®å½•ç»“æ„

```
hdty-data-overview/
â”œâ”€ public/                          # é™æ€èµ„æº
â”‚  â””â”€ index.html
â”œâ”€ src/
â”‚  â”œâ”€ api/                          # APIæ¥å£
â”‚  â”‚  â”œâ”€ column.js                  # åˆ—é…ç½®æ¥å£
â”‚  â”‚  â”œâ”€ form.js                    # è¡¨å•é…ç½®æ¥å£
â”‚  â”‚  â”œâ”€ data.js                    # ä¸šåŠ¡æ•°æ®æ¥å£
â”‚  â”‚  â””â”€ stat.js                    # ç»Ÿè®¡æ¥å£
â”‚  â”œâ”€ assets/                       # èµ„æºæ–‡ä»¶
â”‚  â”‚  â”œâ”€ styles/                    # æ ·å¼
â”‚  â”‚  â”‚  â”œâ”€ common.scss             # é€šç”¨æ ·å¼
â”‚  â”‚  â”‚  â””â”€ variables.scss          # å˜é‡å®šä¹‰
â”‚  â”‚  â””â”€ images/                    # å›¾ç‰‡
â”‚  â”œâ”€ components/                   # é€šç”¨ç»„ä»¶
â”‚  â”‚  â”œâ”€ DynamicForm/               # åŠ¨æ€è¡¨å•ç»„ä»¶
â”‚  â”‚  â”‚  â”œâ”€ index.vue
â”‚  â”‚  â”‚  â”œâ”€ FormRender.vue          # è¡¨å•æ¸²æŸ“å™¨
â”‚  â”‚  â”‚  â”œâ”€ FormItem.vue            # è¡¨å•é¡¹
â”‚  â”‚  â”‚  â””â”€ FieldTypes/             # å­—æ®µç±»å‹ç»„ä»¶
â”‚  â”‚  â”‚     â”œâ”€ InputField.vue
â”‚  â”‚  â”‚     â”œâ”€ SelectField.vue
â”‚  â”‚  â”‚     â”œâ”€ DateField.vue
â”‚  â”‚  â”‚     â””â”€ TextareaField.vue
â”‚  â”‚  â”œâ”€ MultiLevelTable/           # å¤šçº§è¡¨å¤´è¡¨æ ¼
â”‚  â”‚  â”‚  â”œâ”€ index.vue
â”‚  â”‚  â”‚  â””â”€ ColumnRender.vue        # åˆ—æ¸²æŸ“å™¨
â”‚  â”‚  â”œâ”€ TreeSelect/                # æ ‘å½¢é€‰æ‹©å™¨
â”‚  â”‚  â”‚  â””â”€ index.vue
â”‚  â”‚  â””â”€ ColumnConfig/              # åˆ—é…ç½®ç»„ä»¶
â”‚  â”‚     â”œâ”€ index.vue
â”‚  â”‚     â”œâ”€ TreeEditor.vue          # æ ‘å½¢ç¼–è¾‘å™¨
â”‚  â”‚     â””â”€ ColumnEditor.vue        # åˆ—ç¼–è¾‘å™¨
â”‚  â”œâ”€ views/                        # é¡µé¢
â”‚  â”‚  â”œâ”€ stat/                      # æ•°æ®ç»Ÿè®¡æ¨¡å—
â”‚  â”‚  â”‚  â”œâ”€ DataStat.vue            # æ•°æ®ç»Ÿè®¡åˆ—è¡¨é¡µ
â”‚  â”‚  â”‚  â””â”€ DataDetail.vue          # æ˜ç»†æ•°æ®å¼¹çª—
â”‚  â”‚  â”œâ”€ config/                    # é…ç½®ç®¡ç†æ¨¡å—
â”‚  â”‚  â”‚  â”œâ”€ ColumnConfig.vue        # åˆ—é…ç½®ç®¡ç†
â”‚  â”‚  â”‚  â”œâ”€ FormConfig.vue          # è¡¨å•é…ç½®ç®¡ç†
â”‚  â”‚  â”‚  â””â”€ FormFieldConfig.vue     # è¡¨å•å­—æ®µé…ç½®
â”‚  â”‚  â””â”€ dashboard/                 # ä»ªè¡¨ç›˜
â”‚  â”‚     â””â”€ index.vue
â”‚  â”œâ”€ router/                       # è·¯ç”±é…ç½®
â”‚  â”‚  â””â”€ index.js
â”‚  â”œâ”€ store/                        # VuexçŠ¶æ€ç®¡ç†
â”‚  â”‚  â”œâ”€ index.js
â”‚  â”‚  â””â”€ modules/
â”‚  â”‚     â”œâ”€ column.js               # åˆ—é…ç½®çŠ¶æ€
â”‚  â”‚     â”œâ”€ form.js                 # è¡¨å•é…ç½®çŠ¶æ€
â”‚  â”‚     â””â”€ user.js                 # ç”¨æˆ·çŠ¶æ€
â”‚  â”œâ”€ utils/                        # å·¥å…·å‡½æ•°
â”‚  â”‚  â”œâ”€ request.js                 # Axioså°è£…
â”‚  â”‚  â”œâ”€ validate.js                # è¡¨å•éªŒè¯
â”‚  â”‚  â”œâ”€ tree.js                    # æ ‘å½¢æ•°æ®å¤„ç†
â”‚  â”‚  â””â”€ common.js                  # é€šç”¨å·¥å…·
â”‚  â”œâ”€ mixins/                       # æ··å…¥
â”‚  â”‚  â”œâ”€ tableMixin.js              # è¡¨æ ¼æ··å…¥
â”‚  â”‚  â””â”€ formMixin.js               # è¡¨å•æ··å…¥
â”‚  â”œâ”€ App.vue                       # æ ¹ç»„ä»¶
â”‚  â””â”€ main.js                       # å…¥å£æ–‡ä»¶
â”œâ”€ package.json                     # ä¾èµ–é…ç½®
â”œâ”€ vue.config.js                    # Vue CLIé…ç½®
â””â”€ .eslintrc.js                     # ESLinté…ç½®
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 2.1 å¤šçº§è¡¨å¤´åŠ¨æ€æ¸²æŸ“

#### 2.1.1 ç»„ä»¶è®¾è®¡: MultiLevelTable

**åŠŸèƒ½**: æ ¹æ®æ ‘å½¢åˆ—é…ç½®åŠ¨æ€ç”Ÿæˆå¤šçº§è¡¨å¤´

**æ ¸å¿ƒæ€è·¯**:
- é€’å½’æ¸²æŸ“`<el-table-column>`
- æ”¯æŒå±•å¼€/æ”¶èµ·æ§åˆ¶
- å•å…ƒæ ¼ç‚¹å‡»äº‹ä»¶å¤„ç†

**ç»„ä»¶ç»“æ„**:

```vue
<!-- components/MultiLevelTable/index.vue -->
<template>
  <el-table
    :data="tableData"
    border
    stripe
    v-loading="loading"
    style="width: 100%"
  >
    <!-- é€’å½’æ¸²æŸ“åˆ— -->
    <column-render
      v-for="column in visibleColumns"
      :key="column.id"
      :column="column"
      @cell-click="handleCellClick"
    />
  </el-table>
</template>

<script>
import ColumnRender from './ColumnRender.vue'

export default {
  name: 'MultiLevelTable',
  components: { ColumnRender },
  props: {
    columns: {
      type: Array,
      default: () => []
    },
    data: {
      type: Array,
      default: () => []
    },
    loading: Boolean
  },
  data() {
    return {
      expandedColumns: [] // å±•å¼€çš„åˆ—ID
    }
  },
  computed: {
    visibleColumns() {
      return this.filterColumns(this.columns)
    },
    tableData() {
      return this.data
    }
  },
  methods: {
    // è¿‡æ»¤æ˜¾ç¤ºçš„åˆ—(æ ¹æ®å±•å¼€çŠ¶æ€)
    filterColumns(columns) {
      return columns.map(col => {
        const column = { ...col }
        if (column.children && column.children.length > 0) {
          const isExpanded = this.isColumnExpanded(column.id)
          if (isExpanded || column.defaultExpand) {
            column.children = this.filterColumns(column.children)
          } else {
            column.children = []
          }
        }
        return column
      })
    },
    
    // åˆ¤æ–­åˆ—æ˜¯å¦å±•å¼€
    isColumnExpanded(columnId) {
      return this.expandedColumns.includes(columnId)
    },
    
    // åˆ‡æ¢åˆ—å±•å¼€çŠ¶æ€
    toggleColumn(columnId) {
      const index = this.expandedColumns.indexOf(columnId)
      if (index > -1) {
        this.expandedColumns.splice(index, 1)
      } else {
        this.expandedColumns.push(columnId)
      }
    },
    
    // å•å…ƒæ ¼ç‚¹å‡»äº‹ä»¶
    handleCellClick({ column, row, value }) {
      this.$emit('cell-click', { column, row, value })
    }
  }
}
</script>
```

**åˆ—æ¸²æŸ“å™¨**:

```vue
<!-- components/MultiLevelTable/ColumnRender.vue -->
<template>
  <el-table-column
    :prop="column.prop"
    :label="columnLabel"
    :width="column.width"
    :align="column.align || 'center'"
    :fixed="column.fixed"
  >
    <!-- å¦‚æœæœ‰å­åˆ—,é€’å½’æ¸²æŸ“ -->
    <template v-if="hasChildren">
      <column-render
        v-for="child in column.children"
        :key="child.id"
        :column="child"
        @cell-click="$emit('cell-click', $event)"
      />
    </template>
    
    <!-- å¶å­èŠ‚ç‚¹,è‡ªå®šä¹‰æ¸²æŸ“ -->
    <template v-else slot-scope="scope">
      <span
        :class="{ 'clickable': isClickable }"
        @click="handleClick(scope.row, scope.column)"
      >
        {{ scope.row[column.prop] || '-' }}
      </span>
    </template>
  </el-table-column>
</template>

<script>
export default {
  name: 'ColumnRender',
  props: {
    column: {
      type: Object,
      required: true
    }
  },
  computed: {
    hasChildren() {
      return this.column.children && this.column.children.length > 0
    },
    
    isClickable() {
      return !!this.column.formId
    },
    
    columnLabel() {
      // å¦‚æœæœ‰å­åˆ—ä¸”æ”¯æŒå±•å¼€,æ˜¾ç¤ºå±•å¼€/æ”¶èµ·å›¾æ ‡
      if (this.hasChildren) {
        return this.column.label + ' â–¼'
      }
      return this.column.label
    }
  },
  methods: {
    handleClick(row, tableColumn) {
      if (this.isClickable) {
        this.$emit('cell-click', {
          column: this.column,
          row,
          value: row[this.column.prop]
        })
      }
    }
  }
}
</script>

<style scoped>
.clickable {
  color: #409EFF;
  cursor: pointer;
  text-decoration: underline;
}
.clickable:hover {
  color: #66b1ff;
}
</style>
```

---

#### 2.1.2 ä½¿ç”¨ç¤ºä¾‹

```vue
<!-- views/stat/DataStat.vue -->
<template>
  <div class="data-stat">
    <multi-level-table
      :columns="columns"
      :data="statData"
      :loading="loading"
      @cell-click="handleCellClick"
    />
    
    <!-- æ˜ç»†æ•°æ®å¼¹çª— -->
    <data-detail-dialog
      v-if="detailDialogVisible"
      :visible.sync="detailDialogVisible"
      :form-id="currentFormId"
      :org-id="currentOrgId"
    />
  </div>
</template>

<script>
import MultiLevelTable from '@/components/MultiLevelTable'
import DataDetailDialog from './DataDetail.vue'
import { getColumnConfig } from '@/api/column'
import { getStatData } from '@/api/stat'

export default {
  name: 'DataStat',
  components: {
    MultiLevelTable,
    DataDetailDialog
  },
  data() {
    return {
      columns: [],
      statData: [],
      loading: false,
      detailDialogVisible: false,
      currentFormId: null,
      currentOrgId: null
    }
  },
  created() {
    this.loadColumns()
    this.loadData()
  },
  methods: {
    // åŠ è½½åˆ—é…ç½®
    async loadColumns() {
      try {
        const { data } = await getColumnConfig()
        this.columns = this.buildColumnTree(data)
      } catch (error) {
        this.$message.error('åŠ è½½åˆ—é…ç½®å¤±è´¥')
      }
    },
    
    // æ„å»ºåˆ—æ ‘å½¢ç»“æ„
    buildColumnTree(columns) {
      const map = {}
      const roots = []
      
      // å»ºç«‹æ˜ å°„
      columns.forEach(col => {
        map[col.id] = { ...col, children: [] }
      })
      
      // æ„å»ºæ ‘
      columns.forEach(col => {
        if (col.parentId) {
          map[col.parentId].children.push(map[col.id])
        } else {
          roots.push(map[col.id])
        }
      })
      
      return roots
    },
    
    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async loadData() {
      this.loading = true
      try {
        const { data } = await getStatData()
        this.statData = data
      } catch (error) {
        this.$message.error('åŠ è½½æ•°æ®å¤±è´¥')
      } finally {
        this.loading = false
      }
    },
    
    // å•å…ƒæ ¼ç‚¹å‡»å¤„ç†
    handleCellClick({ column, row }) {
      if (column.formId) {
        this.currentFormId = column.formId
        this.currentOrgId = row.orgId
        this.detailDialogVisible = true
      }
    }
  }
}
</script>
```

---

### 2.2 åŠ¨æ€è¡¨å•æ¸²æŸ“

#### 2.2.1 ç»„ä»¶è®¾è®¡: DynamicForm

**åŠŸèƒ½**: æ ¹æ®è¡¨å•é…ç½®åŠ¨æ€æ¸²æŸ“è¡¨å•

**æ ¸å¿ƒæ€è·¯**:
- æ ¹æ® ITEM_CONFIG JSON é…ç½®æ¸²æŸ“ç»„ä»¶
- æ ¹æ® ITEM_TYPE é€‰æ‹©ä¸åŒç»„ä»¶
- æ”¯æŒè¡¨å•éªŒè¯(ä» JSON ä¸­è¯»å– rules)
- æ•°æ®åŒå‘ç»‘å®š

**ç»„ä»¶ç»“æ„**:

```vue
<!-- components/DynamicForm/index.vue -->
<template>
  <el-form
    ref="dynamicForm"
    :model="formData"
    :rules="formRules"
    label-width="120px"
  >
    <el-row :gutter="20">
      <el-col
        v-for="item in formItems"
        :key="item.id"
        :span="getItemLayout(item).span || 12"
      >
        <form-item
          :item="item"
          :value="formData[item.itemProp]"
          @input="handleInput(item.itemProp, $event)"
        />
      </el-col>
    </el-row>
    
    <el-form-item>
      <el-button type="primary" @click="handleSubmit">æäº¤</el-button>
      <el-button @click="handleReset">é‡ç½®</el-button>
    </el-form-item>
  </el-form>
</template>

<script>
import FormItem from './FormItem.vue'

export default {
  name: 'DynamicForm',
  components: { FormItem },
  props: {
    formConfig: {
      type: Object,
      required: true
    },
    formItems: {  // ç»„ä»¶åˆ—è¡¨(ä» SYS_FORM_ITEM_CONFIG æŸ¥è¯¢)
      type: Array,
      default: () => []
    },
    initData: {
      type: Object,
      default: () => ({})
    }
  },
  data() {
    return {
      formData: {},
      formRules: {}
    }
  },
  watch: {
    formItems: {
      handler() {
        this.initFormData()
        this.initFormRules()
      },
      immediate: true
    },
    initData: {
      handler(val) {
        this.formData = { ...this.formData, ...val }
      },
      deep: true
    }
  },
  methods: {
    // åˆå§‹åŒ–è¡¨å•æ•°æ®
    initFormData() {
      const data = {}
      this.formItems.forEach(item => {
        const config = this.parseItemConfig(item)
        data[item.itemProp] = config.defaultValue || null
      })
      this.formData = { ...data, ...this.initData }
    },
    
    // åˆå§‹åŒ–è¡¨å•éªŒè¯è§„åˆ™(ä» JSON é…ç½®è¯»å–)
    initFormRules() {
      const rules = {}
      this.formItems.forEach(item => {
        const config = this.parseItemConfig(item)
        const itemRules = []
        
        // ä» ITEM_CONFIG çš„ rules å­—æ®µè¯»å–éªŒè¯è§„åˆ™
        if (config.rules) {
          // å¿…å¡«éªŒè¯
          if (config.rules.required) {
            itemRules.push({
              required: true,
              message: config.rules.message || `${item.itemLabel}ä¸èƒ½ä¸ºç©º`,
              trigger: config.rules.trigger || 'blur'
            })
          }
          
          // é•¿åº¦éªŒè¯
          if (config.rules.maxLength) {
            itemRules.push({
              max: config.rules.maxLength,
              message: `é•¿åº¦ä¸èƒ½è¶…è¿‡${config.rules.maxLength}ä¸ªå­—ç¬¦`,
              trigger: 'blur'
            })
          }
          
          // æ­£åˆ™éªŒè¯
          if (config.rules.pattern) {
            itemRules.push({
              pattern: new RegExp(config.rules.pattern),
              message: `${item.itemLabel}æ ¼å¼ä¸æ­£ç¡®`,
              trigger: 'blur'
            })
          }
        }
        
        if (itemRules.length > 0) {
          rules[item.itemProp] = itemRules
        }
      })
      this.formRules = rules
    },
    
    // è§£æ ITEM_CONFIG JSON
    parseItemConfig(item) {
      try {
        return JSON.parse(item.itemConfig || '{}')
      } catch {
        return {}
      }
    },
    
    // è·å–ç»„ä»¶å¸ƒå±€é…ç½®
    getItemLayout(item) {
      const config = this.parseItemConfig(item)
      return config.layout || {}
    },
    
    // è¾“å…¥å¤„ç†
    handleInput(prop, value) {
      this.$set(this.formData, prop, value)
    },
    
    // æäº¤è¡¨å•
    handleSubmit() {
      this.$refs.dynamicForm.validate(valid => {
        if (valid) {
          this.$emit('submit', this.formData)
        }
      })
    },
    
    // é‡ç½®è¡¨å•
    handleReset() {
      this.$refs.dynamicForm.resetFields()
    },
    
    // è·å–è¡¨å•æ•°æ®
    getFormData() {
      return this.formData
    },
    
    // è®¾ç½®è¡¨å•æ•°æ®
    setFormData(data) {
      this.formData = { ...this.formData, ...data }
    }
  }
}
</script>
```

**è¡¨å•é¡¹ç»„ä»¶**:

```vue
<!-- components/DynamicForm/FormItem.vue -->
<template>
  <el-form-item
    :label="item.itemLabel"
    :prop="item.itemProp"
    :label-width="itemConfig.layout && itemConfig.layout.labelWidth"
  >
    <component
      :is="itemComponent"
      :item="item"
      :config="itemConfig"
      :value="value"
      @input="$emit('input', $event)"
    />
  </el-form-item>
</template>

<script>
import InputField from './FieldTypes/InputField.vue'
import SelectField from './FieldTypes/SelectField.vue'
import DateField from './FieldTypes/DateField.vue'
import TextareaField from './FieldTypes/TextareaField.vue'

export default {
  name: 'FormItem',
  components: {
    InputField,
    SelectField,
    DateField,
    TextareaField
  },
  props: {
    item: {  // å®Œæ•´çš„ item å¯¹è±¡(åŒ…å« itemConfig JSON)
      type: Object,
      required: true
    },
    value: {
      type: [String, Number, Date, Array],
      default: null
    }
  },
  computed: {
    // è§£æ ITEM_CONFIG JSON
    itemConfig() {
      try {
        return JSON.parse(this.item.itemConfig || '{}')
      } catch {
        return {}
      }
    },
    
    // æ ¹æ® ITEM_TYPE é€‰æ‹©ç»„ä»¶
    itemComponent() {
      const typeMap = {
        'input': 'InputField',
        'select': 'SelectField',
        'date': 'DateField',
        'textarea': 'TextareaField',
        'number': 'InputField'
      }
      return typeMap[this.item.itemType] || 'InputField'
    }
  }
}
</script>
```

**å­—æ®µç±»å‹ç»„ä»¶ç¤ºä¾‹**:

```vue
<!-- components/DynamicForm/FieldTypes/InputField.vue -->
<template>
  <el-input
    :value="value"
    :type="inputType"
    :placeholder="config.componentProps && config.componentProps.placeholder || item.itemLabel"
    :maxlength="config.componentProps && config.componentProps.maxlength"
    :clearable="config.componentProps && config.componentProps.clearable"
    :disabled="config.display && config.display.disabled"
    :readonly="config.display && config.display.readonly"
    @input="$emit('input', $event)"
  />
</template>

<script>
export default {
  name: 'InputField',
  props: {
    item: Object,
    config: Object,  // è§£æåçš„ ITEM_CONFIG
    value: [String, Number]
  },
  computed: {
    inputType() {
      return this.config.componentProps?.type || 'text'
    }
  }
}
</script>
```

```vue
<!-- components/DynamicForm/FieldTypes/SelectField.vue -->
<template>
  <el-select
    :value="value"
    :placeholder="config.componentProps?.placeholder || item.itemLabel"
    :clearable="config.componentProps?.clearable"
    :filterable="config.componentProps?.filterable"
    :multiple="config.componentProps?.multiple"
    :disabled="config.display?.disabled"
    @input="$emit('input', $event)"
  >
    <el-option
      v-for="option in options"
      :key="option.value"
      :label="option.label"
      :value="option.value"
    />
  </el-select>
</template>

<script>
export default {
  name: 'SelectField',
  props: {
    item: Object,
    config: Object,
    value: [String, Number]
  },
  computed: {
    // ä» ITEM_CONFIG çš„ options.data è·å–é€‰é¡¹
    options() {
      return this.config.options?.data || []
    }
  }
}
</script>
```

```vue
<!-- components/DynamicForm/FieldTypes/DateField.vue -->
<template>
  <el-date-picker
    :value="value"
    :type="config.componentProps?.type || 'date'"
    :placeholder="config.componentProps?.placeholder || item.itemLabel"
    :format="config.componentProps?.format || 'yyyy-MM-dd'"
    :value-format="config.componentProps?.valueFormat || 'yyyy-MM-dd'"
    :clearable="config.componentProps?.clearable"
    :disabled="config.display?.disabled"
    @input="$emit('input', $event)"
  />
</template>

<script>
export default {
  name: 'DateField',
  props: {
    item: Object,
    config: Object,
    value: [String, Date]
  }
}
</script>
```

---

#### 2.2.2 ä½¿ç”¨ç¤ºä¾‹

```vue
<!-- views/stat/DataDetail.vue -->
<template>
  <el-dialog
    title="æ˜ç»†æ•°æ®"
    :visible="visible"
    width="80%"
    @close="handleClose"
  >
    <!-- æŸ¥è¯¢è¡¨å• -->
    <dynamic-form
      v-if="queryFields.length > 0"
      ref="queryForm"
      :form-config="formConfig"
      :form-fields="queryFields"
      @submit="handleQuery"
    />
    
    <!-- æ•°æ®åˆ—è¡¨ -->
    <el-table :data="dataList" border>
      <el-table-column
        v-for="field in listFields"
        :key="field.id"
        :prop="field.fieldName"
        :label="field.fieldLabel"
        :width="field.columnWidth"
      />
      <el-table-column label="æ“ä½œ" width="150">
        <template slot-scope="scope">
          <el-button size="mini" @click="handleEdit(scope.row)">ç¼–è¾‘</el-button>
          <el-button size="mini" type="danger" @click="handleDelete(scope.row)">åˆ é™¤</el-button>
        </template>
      </el-table-column>
    </el-table>
    
    <!-- æ–°å¢/ç¼–è¾‘å¼¹çª— -->
    <el-dialog
      :title="editMode === 'add' ? 'æ–°å¢' : 'ç¼–è¾‘'"
      :visible.sync="editDialogVisible"
      width="60%"
      append-to-body
    >
      <dynamic-form
        ref="editForm"
        :form-config="formConfig"
        :form-fields="formFields"
        :init-data="currentRow"
        @submit="handleSave"
      />
    </el-dialog>
  </el-dialog>
</template>

<script>
import DynamicForm from '@/components/DynamicForm'
import { getFormConfig, getFormFields } from '@/api/form'
import { getDataList, saveData, deleteData } from '@/api/data'

export default {
  name: 'DataDetail',
  components: { DynamicForm },
  props: {
    visible: Boolean,
    formId: String,
    orgId: String
  },
  data() {
    return {
      formConfig: {},
      formFields: [],
      queryFields: [],
      listFields: [],
      dataList: [],
      editDialogVisible: false,
      editMode: 'add',
      currentRow: {}
    }
  },
  watch: {
    visible(val) {
      if (val) {
        this.loadFormConfig()
        this.loadData()
      }
    }
  },
  methods: {
    // åŠ è½½è¡¨å•é…ç½®
    async loadFormConfig() {
      try {
        const { data: config } = await getFormConfig(this.formId)
        const { data: fields } = await getFormFields(this.formId)
        
        this.formConfig = config
        this.formFields = fields.filter(f => f.showInForm === 'true')
        this.queryFields = fields.filter(f => f.showInQuery === 'true')
        this.listFields = fields.filter(f => f.showInList === 'true')
      } catch (error) {
        this.$message.error('åŠ è½½è¡¨å•é…ç½®å¤±è´¥')
      }
    },
    
    // åŠ è½½æ•°æ®
    async loadData(queryParams = {}) {
      try {
        const { data } = await getDataList({
          formId: this.formId,
          orgId: this.orgId,
          ...queryParams
        })
        this.dataList = data.map(item => {
          // åˆå¹¶JSONæ•°æ®å’Œæ˜ å°„å­—æ®µ
          return {
            ...item,
            ...JSON.parse(item.dataJson || '{}')
          }
        })
      } catch (error) {
        this.$message.error('åŠ è½½æ•°æ®å¤±è´¥')
      }
    },
    
    // æŸ¥è¯¢
    handleQuery(queryData) {
      this.loadData(queryData)
    },
    
    // æ–°å¢
    handleAdd() {
      this.editMode = 'add'
      this.currentRow = {}
      this.editDialogVisible = true
    },
    
    // ç¼–è¾‘
    handleEdit(row) {
      this.editMode = 'edit'
      this.currentRow = { ...row }
      this.editDialogVisible = true
    },
    
    // ä¿å­˜
    async handleSave(formData) {
      try {
        await saveData({
          id: this.currentRow.id,
          formId: this.formId,
          orgId: this.orgId,
          ...formData
        })
        this.$message.success('ä¿å­˜æˆåŠŸ')
        this.editDialogVisible = false
        this.loadData()
      } catch (error) {
        this.$message.error('ä¿å­˜å¤±è´¥')
      }
    },
    
    // åˆ é™¤
    async handleDelete(row) {
      try {
        await this.$confirm('ç¡®å®šåˆ é™¤è¯¥æ•°æ®?', 'æç¤º', {
          type: 'warning'
        })
        await deleteData(row.id)
        this.$message.success('åˆ é™¤æˆåŠŸ')
        this.loadData()
      } catch (error) {
        if (error !== 'cancel') {
          this.$message.error('åˆ é™¤å¤±è´¥')
        }
      }
    },
    
    // å…³é—­
    handleClose() {
      this.$emit('update:visible', false)
    }
  }
}
</script>
```

---

### 2.3 åˆ—é…ç½®ç®¡ç†

#### 2.3.1 ç»„ä»¶è®¾è®¡: ColumnConfig

**åŠŸèƒ½**: æ ‘å½¢ç»“æ„çš„åˆ—é…ç½®ç¼–è¾‘

**æ ¸å¿ƒæ€è·¯**:
- ä½¿ç”¨`el-tree`å±•ç¤ºåˆ—æ ‘
- æ”¯æŒæ‹–æ‹½æ’åº
- å¼¹çª—ç¼–è¾‘åˆ—å±æ€§

```vue
<!-- views/config/ColumnConfig.vue -->
<template>
  <div class="column-config">
    <el-row :gutter="20">
      <!-- å·¦ä¾§æ ‘å½¢ç»“æ„ -->
      <el-col :span="12">
        <el-card>
          <div slot="header">
            <span>åˆ—ç»“æ„</span>
            <el-button
              style="float: right"
              type="primary"
              size="small"
              @click="handleAdd"
            >
              æ–°å¢æ ¹èŠ‚ç‚¹
            </el-button>
          </div>
          
          <el-tree
            ref="columnTree"
            :data="columnTree"
            node-key="id"
            default-expand-all
            draggable
            :allow-drop="allowDrop"
            @node-click="handleNodeClick"
            @node-drop="handleNodeDrop"
          >
            <span slot-scope="{ node, data }" class="custom-tree-node">
              <span>{{ data.label }}</span>
              <span>
                <el-button
                  type="text"
                  size="mini"
                  @click.stop="handleAddChild(data)"
                >
                  æ·»åŠ å­èŠ‚ç‚¹
                </el-button>
                <el-button
                  type="text"
                  size="mini"
                  @click.stop="handleEdit(data)"
                >
                  ç¼–è¾‘
                </el-button>
                <el-button
                  type="text"
                  size="mini"
                  style="color: #F56C6C"
                  @click.stop="handleDelete(data)"
                >
                  åˆ é™¤
                </el-button>
              </span>
            </span>
          </el-tree>
        </el-card>
      </el-col>
      
      <!-- å³ä¾§é…ç½®è¯¦æƒ… -->
      <el-col :span="12">
        <el-card>
          <div slot="header">åˆ—é…ç½®</div>
          <el-form
            v-if="currentColumn"
            ref="columnForm"
            :model="currentColumn"
            :rules="columnRules"
            label-width="120px"
          >
            <el-form-item label="åˆ—æ ‡é¢˜" prop="label">
              <el-input v-model="currentColumn.label" />
            </el-form-item>
            
            <el-form-item label="å±æ€§å" prop="prop">
              <el-input v-model="currentColumn.prop" placeholder="å¶å­èŠ‚ç‚¹å¿…å¡«" />
            </el-form-item>
            
            <el-form-item label="åˆ—å®½">
              <el-input-number v-model="currentColumn.width" :min="50" />
            </el-form-item>
            
            <el-form-item label="å¯¹é½æ–¹å¼">
              <el-radio-group v-model="currentColumn.align">
                <el-radio label="left">å·¦å¯¹é½</el-radio>
                <el-radio label="center">å±…ä¸­</el-radio>
                <el-radio label="right">å³å¯¹é½</el-radio>
              </el-radio-group>
            </el-form-item>
            
            <el-form-item label="å›ºå®šåˆ—">
              <el-select v-model="currentColumn.fixed" clearable>
                <el-option label="å·¦ä¾§å›ºå®š" value="left" />
                <el-option label="å³ä¾§å›ºå®š" value="right" />
              </el-select>
            </el-form-item>
            
            <el-form-item label="é»˜è®¤å±•å¼€">
              <el-switch
                v-model="currentColumn.defaultExpand"
                active-value="true"
                inactive-value="false"
              />
            </el-form-item>
            
            <el-form-item label="å…³è”è¡¨å•">
              <el-select v-model="currentColumn.formId" clearable>
                <el-option
                  v-for="form in formList"
                  :key="form.id"
                  :label="form.formName"
                  :value="form.id"
                />
              </el-select>
            </el-form-item>
            
            <el-form-item>
              <el-button type="primary" @click="handleSave">ä¿å­˜</el-button>
              <el-button @click="currentColumn = null">å–æ¶ˆ</el-button>
            </el-form-item>
          </el-form>
          
          <el-empty v-else description="è¯·é€‰æ‹©è¦ç¼–è¾‘çš„åˆ—" />
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>

<script>
import { getColumnTree, saveColumn, deleteColumn } from '@/api/column'
import { getFormList } from '@/api/form'

export default {
  name: 'ColumnConfig',
  data() {
    return {
      columnTree: [],
      currentColumn: null,
      formList: [],
      columnRules: {
        label: [
          { required: true, message: 'åˆ—æ ‡é¢˜ä¸èƒ½ä¸ºç©º', trigger: 'blur' }
        ]
      }
    }
  },
  created() {
    this.loadColumnTree()
    this.loadFormList()
  },
  methods: {
    // åŠ è½½åˆ—æ ‘
    async loadColumnTree() {
      try {
        const { data } = await getColumnTree()
        this.columnTree = data
      } catch (error) {
        this.$message.error('åŠ è½½åˆ—é…ç½®å¤±è´¥')
      }
    },
    
    // åŠ è½½è¡¨å•åˆ—è¡¨
    async loadFormList() {
      try {
        const { data } = await getFormList()
        this.formList = data
      } catch (error) {
        this.$message.error('åŠ è½½è¡¨å•åˆ—è¡¨å¤±è´¥')
      }
    },
    
    // èŠ‚ç‚¹ç‚¹å‡»
    handleNodeClick(data) {
      this.currentColumn = { ...data }
    },
    
    // æ–°å¢æ ¹èŠ‚ç‚¹
    handleAdd() {
      this.currentColumn = {
        id: null,
        parentId: null,
        label: '',
        prop: '',
        width: 100,
        align: 'center',
        defaultExpand: 'true'
      }
    },
    
    // æ·»åŠ å­èŠ‚ç‚¹
    handleAddChild(parent) {
      this.currentColumn = {
        id: null,
        parentId: parent.id,
        label: '',
        prop: '',
        width: 100,
        align: 'center',
        defaultExpand: 'true'
      }
    },
    
    // ç¼–è¾‘
    handleEdit(data) {
      this.currentColumn = { ...data }
    },
    
    // ä¿å­˜
    async handleSave() {
      try {
        await this.$refs.columnForm.validate()
        await saveColumn(this.currentColumn)
        this.$message.success('ä¿å­˜æˆåŠŸ')
        this.loadColumnTree()
        this.currentColumn = null
      } catch (error) {
        if (error !== false) {
          this.$message.error('ä¿å­˜å¤±è´¥')
        }
      }
    },
    
    // åˆ é™¤
    async handleDelete(data) {
      try {
        await this.$confirm('ç¡®å®šåˆ é™¤è¯¥åˆ—?', 'æç¤º', { type: 'warning' })
        await deleteColumn(data.id)
        this.$message.success('åˆ é™¤æˆåŠŸ')
        this.loadColumnTree()
        this.currentColumn = null
      } catch (error) {
        if (error !== 'cancel') {
          this.$message.error('åˆ é™¤å¤±è´¥')
        }
      }
    },
    
    // æ‹–æ‹½é™åˆ¶
    allowDrop(draggingNode, dropNode, type) {
      return type !== 'inner' || dropNode.data.children
    },
    
    // æ‹–æ‹½å®Œæˆ
    async handleNodeDrop() {
      // æ›´æ–°æ’åº
      const updateSortNum = (nodes, parentId = null) => {
        nodes.forEach((node, index) => {
          node.sortNum = index
          node.parentId = parentId
          if (node.children) {
            updateSortNum(node.children, node.id)
          }
        })
      }
      updateSortNum(this.columnTree)
      
      // ä¿å­˜æ’åº
      try {
        await saveColumn(this.columnTree)
        this.$message.success('æ’åºå·²æ›´æ–°')
      } catch (error) {
        this.$message.error('æ›´æ–°æ’åºå¤±è´¥')
      }
    }
  }
}
</script>

<style scoped>
.custom-tree-node {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  font-size: 14px;
}
</style>
```

---

### 2.4 è¡¨å•é…ç½®ç®¡ç†

**åŠŸèƒ½**: å¯è§†åŒ–é…ç½®åŠ¨æ€è¡¨å•

```vue
<!-- views/config/FormConfig.vue -->
<template>
  <div class="form-config">
    <!-- è¡¨å•åˆ—è¡¨ -->
    <el-table :data="formList" border>
      <el-table-column prop="formCode" label="è¡¨å•ç¼–ç " />
      <el-table-column prop="formName" label="è¡¨å•åç§°" />
      <el-table-column prop="dataTable" label="æ•°æ®è¡¨" />
      <el-table-column prop="status" label="çŠ¶æ€">
        <template slot-scope="scope">
          <el-tag :type="scope.row.status === '1' ? 'success' : 'danger'">
            {{ scope.row.status === '1' ? 'å¯ç”¨' : 'ç¦ç”¨' }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="æ“ä½œ" width="300">
        <template slot-scope="scope">
          <el-button size="mini" @click="handleEditForm(scope.row)">ç¼–è¾‘</el-button>
          <el-button size="mini" type="primary" @click="handleConfigFields(scope.row)">
            é…ç½®å­—æ®µ
          </el-button>
          <el-button size="mini" type="success" @click="handlePreview(scope.row)">
            é¢„è§ˆ
          </el-button>
        </template>
      </el-table-column>
    </el-table>
    
    <!-- å­—æ®µé…ç½®å¼¹çª— -->
    <form-field-config
      v-if="fieldConfigVisible"
      :visible.sync="fieldConfigVisible"
      :form-id="currentFormId"
    />
  </div>
</template>

<script>
import { getFormList } from '@/api/form'
import FormFieldConfig from './FormFieldConfig.vue'

export default {
  name: 'FormConfig',
  components: { FormFieldConfig },
  data() {
    return {
      formList: [],
      fieldConfigVisible: false,
      currentFormId: null
    }
  },
  created() {
    this.loadFormList()
  },
  methods: {
    async loadFormList() {
      const { data } = await getFormList()
      this.formList = data
    },
    
    handleConfigFields(row) {
      this.currentFormId = row.id
      this.fieldConfigVisible = true
    }
  }
}
</script>
```

---

## ğŸ“¡ APIæ¥å£å°è£…

### 3.1 Axioså°è£…

```javascript
// utils/request.js
import axios from 'axios'
import { Message } from 'element-ui'

const service = axios.create({
  baseURL: process.env.VUE_APP_BASE_API,
  timeout: 10000
})

// è¯·æ±‚æ‹¦æˆªå™¨
service.interceptors.request.use(
  config => {
    // æ·»åŠ token
    const token = localStorage.getItem('token')
    if (token) {
      config.headers['Authorization'] = `Bearer ${token}`
    }
    return config
  },
  error => {
    return Promise.reject(error)
  }
)

// å“åº”æ‹¦æˆªå™¨
service.interceptors.response.use(
  response => {
    const res = response.data
    if (res.code !== 200) {
      Message.error(res.message || 'è¯·æ±‚å¤±è´¥')
      return Promise.reject(new Error(res.message || 'è¯·æ±‚å¤±è´¥'))
    }
    return res
  },
  error => {
    Message.error(error.message || 'ç½‘ç»œé”™è¯¯')
    return Promise.reject(error)
  }
)

export default service
```

---

### 3.2 APIæ¨¡å—

```javascript
// api/column.js
import request from '@/utils/request'

// è·å–åˆ—é…ç½®æ ‘
export function getColumnTree() {
  return request({
    url: '/api/column/tree',
    method: 'get'
  })
}

// è·å–åˆ—é…ç½®
export function getColumnConfig(id) {
  return request({
    url: `/api/column/${id}`,
    method: 'get'
  })
}

// ä¿å­˜åˆ—é…ç½®
export function saveColumn(data) {
  return request({
    url: '/api/column/save',
    method: 'post',
    data
  })
}

// åˆ é™¤åˆ—é…ç½®
export function deleteColumn(id) {
  return request({
    url: `/api/column/${id}`,
    method: 'delete'
  })
}
```

```javascript
// api/form.js
import request from '@/utils/request'

// è·å–è¡¨å•åˆ—è¡¨
export function getFormList() {
  return request({
    url: '/api/form/list',
    method: 'get'
  })
}

// è·å–è¡¨å•é…ç½®
export function getFormConfig(id) {
  return request({
    url: `/api/form/${id}`,
    method: 'get'
  })
}

// è·å–è¡¨å•ç»„ä»¶(ä»¥å‰æ˜¯ getFormFields,ç°åœ¨æ”¹ä¸º getFormItems)
export function getFormItems(formId, useType) {
  return request({
    url: `/api/form/${formId}/items`,
    method: 'get',
    params: { useType }  // 01-appè¡¨å• 02-appåˆ—è¡¨ 03-pcåˆ—è¡¨ 04-pcè¡¨å•
  })
}

// ä¿å­˜è¡¨å•ç»„ä»¶
export function saveFormItem(data) {
  return request({
    url: '/api/form/item/save',
    method: 'post',
    data
  })
}
```

```javascript
// api/data.js
import request from '@/utils/request'

// è·å–æ•°æ®åˆ—è¡¨
export function getDataList(params) {
  return request({
    url: '/api/data/list',
    method: 'get',
    params
  })
}

// ä¿å­˜æ•°æ®
export function saveData(data) {
  return request({
    url: '/api/data/save',
    method: 'post',
    data
  })
}

// åˆ é™¤æ•°æ®
export function deleteData(id) {
  return request({
    url: `/api/data/${id}`,
    method: 'delete'
  })
}
```

```javascript
// api/stat.js
import request from '@/utils/request'

// è·å–ç»Ÿè®¡æ•°æ®
export function getStatData(params) {
  return request({
    url: '/api/stat/data',
    method: 'get',
    params
  })
}

// åˆ·æ–°ç»Ÿè®¡
export function refreshStat(params) {
  return request({
    url: '/api/stat/refresh',
    method: 'post',
    data: params
  })
}
```

---

## ğŸ¨ æ ·å¼ä¸ä¸»é¢˜

### 4.1 é€šç”¨æ ·å¼

```scss
// assets/styles/common.scss
.clickable {
  color: #409EFF;
  cursor: pointer;
  text-decoration: underline;
  
  &:hover {
    color: #66b1ff;
  }
}

.custom-tree-node {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  font-size: 14px;
}
```

---

## ğŸ§ª å•å…ƒæµ‹è¯•

```javascript
// tests/unit/DynamicForm.spec.js
import { mount } from '@vue/test-utils'
import DynamicForm from '@/components/DynamicForm'

describe('DynamicForm.vue', () => {
  it('renders form fields correctly', () => {
    const formFields = [
      { id: '1', fieldName: 'name', fieldLabel: 'å§“å', fieldType: 'input' }
    ]
    const wrapper = mount(DynamicForm, {
      propsData: { formFields }
    })
    expect(wrapper.text()).toContain('å§“å')
  })
})
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-11-25
