# 动态表单与列表配置设计文档

## 一、配置设计概述

本文档描述了数据晾晒系统中动态表单和动态列表的配置设计方案，支持完全配置化的增删改查功能。

## 二、配置层级关系

```
统计列配置 (Column)
  └── formId (关联) → 表单配置 (Form)
                        └── 表单项配置 (FormItem)
```

## 三、表单项配置 (FormItem)

### 3.1 基础字段说明

| 字段       | 类型   | 说明                             |
| ---------- | ------ | -------------------------------- |
| itemType   | String | 组件类型(input/select/date等)    |
| itemLabel  | String | 字段标签                         |
| itemProp   | String | 字段属性名                       |
| itemOrder  | Number | 排序号                           |
| isFixed    | String | 是否映射表字段(0否/1是)          |
| tableKey   | String | 映射的数据库列名                 |
| keyType    | String | 列类型(field/dict/org/region等)  |
| dataType   | String | 数据类型(VARCHAR2/NUMBER/DATE等) |
| dicType    | String | 字典类型编码                     |
| itemConfig | JSON   | 组件配置JSON                     |
| isQuery    | String | 是否查询字段(0否/1是)            |
| isShow     | String | 是否显示(0否/1是)                |
| span       | Number | 表单栅格占位(12/24)              |

### 3.2 itemConfig 配置示例

#### 3.2.1 输入框 (input)
```json
{
  "placeholder": "请输入姓名",
  "maxlength": 100,
  "defaultValue": "",
  "disabled": false,
  "readonly": false
}
```

#### 3.2.2 下拉选择 (select)
```json
{
  "placeholder": "请选择状态",
  "multiple": false,
  "filterable": true,
  "options": [
    { "label": "启用", "value": "1" },
    { "label": "禁用", "value": "0" }
  ]
}
```

#### 3.2.3 字典选择 (dict-select / dict-radio / dict-checkbox)
```json
{
  "dictCode": "ZXBS",
  "placeholder": "请选择注销状态",
  "filterable": true,
  "multiple": false
}
```

#### 3.2.4 日期选择 (date / datetime / daterange)
```json
{
  "type": "date",
  "placeholder": "请选择日期",
  "format": "yyyy-MM-dd",
  "valueFormat": "yyyy-MM-dd"
}
```

#### 3.2.5 机构选择 (organ)
```json
{
  "placeholder": "请选择机构",
  "multiple": false,
  "showLevel": true,
  "filterCode": ""
}
```

#### 3.2.6 地区选择 (region)
```json
{
  "placeholder": "请选择地区",
  "multiple": false
}
```

#### 3.2.7 数字输入 (number)
```json
{
  "min": 0,
  "max": 999999,
  "precision": 2,
  "step": 1
}
```

### 3.3 布局配置说明

- **span=24**: 字段独占一行(适用于文本域、JSON编辑器等)
- **span=12**: 一行显示2个字段(默认布局)
- **span=8**: 一行显示3个字段(紧凑布局)

## 四、列配置 (Column)

### 4.1 基础字段说明

| 字段        | 类型   | 说明                                   |
| ----------- | ------ | -------------------------------------- |
| prop        | String | 列属性名                               |
| label       | String | 列标签                                 |
| columnWidth | Number | 列宽度                                 |
| align       | String | 对齐方式(left/center/right)            |
| formId      | String | 关联的表单ID(配置后可点击查看明细)     |
| calcType    | String | 计算类型(sum/avg/count/max/min/custom) |
| calcRule    | JSON   | 计算规则JSON                           |

### 4.2 关联表单的列配置

当列配置了 `formId` 后，点击该列单元格将弹出二级明细列表。

## 五、表单配置 (Form)

### 5.1 基础字段说明

| 字段           | 类型   | 说明                    |
| -------------- | ------ | ----------------------- |
| formName       | String | 表单名称                |
| formCode       | String | 表单编码                |
| formType       | String | 表单类型(COMMON/CUSTOM) |
| dataTable      | String | 数据表名                |
| displayColumns | JSON   | 列表展示列配置          |

### 5.2 displayColumns 配置示例

```json
[
  {
    "prop": "fieldName",
    "label": "字段名",
    "width": 150,
    "align": "left",
    "sortable": false,
    "showOverflowTooltip": true,
    "format": "text"
  },
  {
    "prop": "createTime",
    "label": "创建时间",
    "width": 180,
    "format": "datetime"
  }
]
```

## 六、数据流转说明

### 6.1 统计页面点击流程

```
1. 用户点击统计列表某个配置了formId的单元格
   ↓
2. 系统获取 formId、orgId、columnProp
   ↓
3. 根据 formId 加载表单配置(Form)
   ↓
4. 根据表单配置加载表单项列表(FormItem)
   ↓
5. 构建查询表单、列表展示列、新增/编辑表单
   ↓
6. 展示二级明细弹窗
```

### 6.2 二级明细CRUD流程

#### 查询
- 从 FormItem 中筛选 `isQuery=1` 的字段构建查询表单
- 提交查询参数，加载明细数据列表

#### 新增/编辑
- 从 FormItem 中筛选 `isShow=1` 的字段构建表单
- 根据 `span` 配置控制布局(12=一行2个, 24=独占一行)
- 根据 `itemType` 和 `itemConfig` 渲染对应组件
- 提交数据到后端

#### 详情
- 表单设置为只读模式(`mode=view`)
- 展示完整字段信息

## 七、实现要点

### 7.1 动态表单组件优化

1. **支持精准布局控制**
   - 通过 `span` 属性控制字段占位
   - 支持自定义每行显示的字段数

2. **支持多种字段类型**
   - 原生组件: input、textarea、select、radio、checkbox
   - HDty组件: hd-organ、hd-region、hd-dict-select等

3. **支持三种模式**
   - add: 新增模式
   - edit: 编辑模式
   - view: 查看模式(只读)

### 7.2 动态列表组件优化

1. **支持列配置驱动**
   - 从表单配置的 `displayColumns` 或 FormItem 配置生成列

2. **支持数据格式化**
   - 日期格式化
   - 数字格式化
   - 字典翻译

3. **支持CRUD操作**
   - 编辑、删除按钮可配置显示/隐藏

### 7.3 二级明细弹窗

1. **完整的增删改查功能**
2. **支持分页**
3. **支持查询过滤**
4. **操作后刷新统计数据**

## 八、配置示例

### 8.1 完整配置示例

假设配置"人员信息"二级明细:

#### 表单配置 (Form)
```json
{
  "id": "form_001",
  "formName": "人员信息表单",
  "formCode": "PERSON_INFO",
  "formType": "COMMON",
  "dataTable": "BIZ_DATA_COMMON",
  "displayColumns": [
    {
      "prop": "name",
      "label": "姓名",
      "width": 120,
      "align": "left"
    },
    {
      "prop": "age",
      "label": "年龄",
      "width": 80,
      "align": "center"
    }
  ]
}
```

#### 表单项配置 (FormItem)

**字段1: 姓名(查询+显示)**
```json
{
  "formId": "form_001",
  "itemType": "input",
  "itemLabel": "姓名",
  "itemProp": "name",
  "itemOrder": 1,
  "isFixed": "1",
  "tableKey": "F_FIELD_1",
  "keyType": "field",
  "dataType": "VARCHAR2",
  "isQuery": "1",
  "isShow": "1",
  "span": 12,
  "itemConfig": {
    "placeholder": "请输入姓名",
    "maxlength": 50
  }
}
```

**字段2: 年龄(仅显示)**
```json
{
  "formId": "form_001",
  "itemType": "number",
  "itemLabel": "年龄",
  "itemProp": "age",
  "itemOrder": 2,
  "isFixed": "1",
  "tableKey": "F_NUM_1",
  "keyType": "num",
  "dataType": "NUMBER",
  "isQuery": "0",
  "isShow": "1",
  "span": 12,
  "itemConfig": {
    "min": 0,
    "max": 150
  }
}
```

**字段3: 备注(独占一行)**
```json
{
  "formId": "form_001",
  "itemType": "textarea",
  "itemLabel": "备注",
  "itemProp": "memo",
  "itemOrder": 3,
  "isFixed": "1",
  "tableKey": "F_FIELD_6",
  "keyType": "field",
  "dataType": "VARCHAR2",
  "isQuery": "0",
  "isShow": "1",
  "span": 24,
  "itemConfig": {
    "placeholder": "请输入备注",
    "rows": 3,
    "maxlength": 500
  }
}
```

## 九、技术要点总结

1. **配置驱动**: 所有UI展示和交互完全由配置驱动
2. **组件复用**: 动态表单、动态列表组件高度复用
3. **灵活布局**: 通过span精准控制表单布局
4. **类型丰富**: 支持多种HDty组件类型
5. **扩展性强**: 新增字段类型只需扩展FieldRender组件

## 十、后续优化方向

1. 支持字段联动(字段A变化影响字段B)
2. 支持条件显示(根据其他字段值控制显示/隐藏)
3. 支持自定义校验规则
4. 支持表单分组/分步骤
5. 支持批量导入/导出

---

**文档版本**: v1.0  
**最后更新**: 2025-12-02  
**维护人员**: AI助手
